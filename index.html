A<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>VeriPura Demo — Single File Build</title>
  <style>
    :root{
      --bg:#0b0d10;
      --panel:#11151a;
      --muted:#1a1f26;
      --text:#e7edf3;
      --sub:#a4b0be;
      --brand:#4ade80;
      --accent:#60a5fa;
      --warn:#fbbf24;
      --danger:#f87171;
      --ok:#34d399;
      --chip:#0f1720;
      --border:#22303d;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, Apple Color Emoji, Segoe UI Emoji;
    }
    a{color:var(--accent);text-decoration:none}
    .hidden{display:none!important}
    .row{display:flex;gap:.75rem;align-items:center}
    .col{display:flex;flex-direction:column;gap:.5rem}
    .btn{
      background:linear-gradient(180deg,#1b222b,#121820);
      color:var(--text);
      border:1px solid var(--border);
      padding:.55rem .8rem;
      border-radius:.6rem;
      cursor:pointer;
      transition:transform .05s ease,background .2s ease,opacity .2s ease;
      font-weight:600;
    }
    .btn:hover{transform:translateY(-1px)}
    .btn:disabled{opacity:.55;cursor:not-allowed}
    .btn-primary{background:linear-gradient(180deg,#1e2732,#15202b);border-color:#294357}
    .btn-brand{background:linear-gradient(180deg,#21b861,#15924a);border-color:#157a40}
    .btn-warn{background:#3a2a10;border-color:#5a4217;color:#ffd37a}
    .btn-danger{background:#3a1214;border-color:#5f1a20;color:#ffb4b7}
    .chip{
      display:inline-flex;align-items:center;gap:.4rem;
      padding:.25rem .5rem;border-radius:999px;
      background:var(--chip);border:1px solid var(--border);
      font-size:.75rem;color:var(--sub)
    }
    .layout{display:grid;grid-template-columns:260px 1fr;min-height:100vh}
    .sidebar{
      background:linear-gradient(180deg,#0e1318,#0b0f13);
      border-right:1px solid var(--border);padding:1rem;position:sticky;top:0;height:100vh;overflow:auto
    }
    .brand{font-weight:800;letter-spacing:.3px}
    .brand small{display:block;color:var(--sub);font-weight:600}
    .nav{margin-top:1rem;display:flex;flex-direction:column;gap:.25rem}
    .nav button{
      text-align:left;width:100%;
      background:transparent;border:1px solid transparent;color:var(--text);
      padding:.55rem .6rem;border-radius:.55rem;cursor:pointer
    }
    .nav button.active,.nav button:hover{background:var(--panel);border-color:var(--border)}
    main{padding:1rem 1.25rem}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:.9rem;padding:1rem}
    .grid{display:grid;gap:1rem}
    .grid.cols-2{grid-template-columns:1fr 1fr}
    .grid.cols-3{grid-template-columns:repeat(3,1fr)}
    .grid.cols-4{grid-template-columns:repeat(4,1fr)}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{border-bottom:1px solid var(--border);padding:.5rem .4rem;text-align:left;font-size:.92rem;vertical-align:top}
    .table th{color:var(--sub);font-weight:700}
    .table th.sortable{cursor:pointer}
    .table th.sortable:hover{color:var(--text)}
    .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;font-size:.85rem;background:#0f1420;border:1px solid #1e2b38;padding:.1rem .35rem;border-radius:.35rem}
    .input, select, textarea{
      background:#0c1117;border:1px solid var(--border);color:var(--text);
      padding:.5rem .55rem;border-radius:.55rem;outline:none
    }
    textarea{min-height:90px;resize:vertical}
    .label{font-size:.85rem;color:var(--sub)}
    .section-title{font-size:1.1rem;font-weight:800;margin:.25rem 0 .75rem 0}
    .row-between{display:flex;align-items:center;justify-content:space-between;gap:.75rem}
    .accordion-item{border:1px solid var(--border);border-radius:.7rem;overflow:hidden;background:#0e1319}
    .accordion-head{padding:.6rem .8rem;cursor:pointer;display:flex;align-items:center;justify-content:space-between}
    .accordion-body{padding:1rem;border-top:1px solid var(--border);display:none}
    .tag{font-size:.72rem;padding:.15rem .45rem;border-radius:.4rem;border:1px solid var(--border);background:#0c1318;color:var(--sub)}
    .tag.ok{color:#9fffc3;border-color:#1d5437;background:#0c1a14}
    .tag.warn{color:#ffe39a;border-color:#4a3511;background:#1a140c}
    .tag.block{color:#ffb2b2;border-color:#5a1a1a;background:#1a0c0c}
    .toast{
      position:fixed;bottom:18px;right:18px;background:#0f1720;color:#e9f0f6;border:1px solid #1f2b37;
      padding:.65rem .8rem;border-radius:.6rem;min-width:200px;box-shadow:0 8px 20px rgba(0,0,0,.35);z-index:9999
    }
    .toast.ok{border-color:#1d5136}
    .toast.warn{border-color:#614b17}
    .toast.err{border-color:#5b1a1a}
    .muted{color:var(--sub)}
    .divider{height:1px;background:var(--border);margin:.75rem 0}
    .pill{padding:.15rem .45rem;border-radius:999px;border:1px solid var(--border);background:#0a1016;color:var(--sub);font-size:.7rem}
    .right{margin-left:auto}
    .metric{display:flex;flex-direction:column;gap:.25rem}
    .metric .h{font-size:.85rem;color:var(--sub)}
    .metric .v{font-size:1.2rem;font-weight:800}
    .danger{color:#ffb4b7}
    .oktext{color:#9fffc3}
    .warntext{color:#ffe39a}
    .inline-form{display:flex;gap:.5rem;flex-wrap:wrap;align-items:center}
    .nowrap{white-space:nowrap}
    .small{font-size:.85rem}
    .sr-only{position:absolute!important;height:1px;width:1px;overflow:hidden;clip:rect(1px, 1px, 1px, 1px);white-space:nowrap;border:0;padding:0;margin:-1px}

    /* Admin Tab styles */
    .admin-tabs{display:flex;gap:.5rem;border-bottom:1px solid var(--border);margin-bottom:1rem;}
    .admin-tabs button{background:transparent;border:none;padding:.6rem .8rem;cursor:pointer;color:var(--sub);font-weight:600;border-bottom:2px solid transparent}
    .admin-tabs button.active{color:var(--text);border-bottom-color:var(--brand)}
    .admin-content{display:none;}
    .admin-content.active{display:block;}

.btn-ok {
    background:linear-gradient(180deg,#15a37a,#108e68);
    border-color:#157a40;
    color: white;
}
.btn-ok:hover {
  filter: brightness(0.95);
}

</style>

<script>
(function(){
  try{
    var k = 'vp_theme';
    var s = localStorage.getItem(k);
    var t = s ? s : ((window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) ? 'dark' : 'light');
    document.documentElement.setAttribute('data-theme', t);
  }catch(e){}
})();
</script>

<style id="vp-light-theme">
  /* Softer, low‑glare palette */
  html[data-theme="light"]{
    --bg:#eef2f6;            /* page background – soft cool grey */
    --panel:#ffffff;         /* cards/panels */
    --muted:#f5f7fb;         /* muted fills */
    --text:#0e1623;          /* main text */
    --sub:#485260;           /* secondary text */
    --brand:#16a34a;         /* VeriPura green */
    --accent:#2563eb;        /* links/accents */
    --warn:#b45309;
    --danger:#b91c1c;
    --ok:#059669;
    --chip:#f8fafc;
    --border:#dfe6ef;        /* slightly stronger than before */
    --shadow:0 1px 2px rgba(16,24,40,.06),0 4px 12px rgba(16,24,40,.06);
  }

  /* Base */
  html[data-theme="light"] body{ background:var(--bg); color:var(--text); }
  html[data-theme="light"] a{ color:var(--accent); }

  /* Panels / cards / sidebar */
  html[data-theme="light"] .card,
  html[data-theme="light"] .panel,
  html[data-theme="light"] .sidebar,
  html[data-theme="light"] header,
  html[data-theme="light"] footer,
  html[data-theme="light"] main,
  html[data-theme="light"] section,
  html[data-theme="light"] nav{
    background:var(--panel);
    box-shadow:var(--shadow);
    border-color:var(--border);
  }

  /* Inputs */
  html[data-theme="light"] input,
  html[data-theme="light"] select,
  html[data-theme="light"] textarea{
    background:#ffffff;
    border:1px solid var(--border);
    color:var(--text);
  }
  html[data-theme="light"] input::placeholder,
  html[data-theme="light"] textarea::placeholder{ color:#778396; }

  /* Buttons */
  html[data-theme="light"] .btn{
    background:linear-gradient(180deg,#ffffff,#f3f6fb);
    border:1px solid var(--border);
    color:var(--text);
  }
  html[data-theme="light"] .btn:hover{ filter:brightness(.98); }
  html[data-theme="light"] .btn:active{ transform:translateY(1px); }

  /* Tags / statuses use color tints for readability */
  html[data-theme="light"] .tag{ 
    color:#1f2a37; 
    background:#f2f5fa; 
    border:1px solid #e1e7f0; 
  }
  html[data-theme="light"] .tag.ok{ 
    color:#166534; 
    background:#eafaf1; 
    border-color:#c6ead6; 
  }
  html[data-theme="light"] .tag.warn{ 
    color:#92400e; 
    background:#fff4e5; 
    border-color:#f3d0a6; 
  }
  html[data-theme="light"] .tag.block{ 
    color:#9f1239; 
    background:#feecef; 
    border-color:#f6c6cf; 
  }

  /* Chips */
  html[data-theme="light"] .chip{
    background:var(--chip);
    border:1px solid var(--border);
    color:var(--sub);
  }

  /* Accordion items (e.g., PO rows) */
  html[data-theme="light"] .accordion-item{ 
    background:#ffffff; 
    border:1px solid var(--border); 
    box-shadow:var(--shadow);
  }

  /* Tables: zebra rows & clearer headers */
  html[data-theme="light"] .table th{ 
    background:#f2f6fb; 
    color:#1f2a37; 
    border-bottom:1px solid var(--border);
  }
  html[data-theme="light"] .table tr:nth-child(even) td{ background:#fbfdff; }

  /* KBD / helper keys */
  html[data-theme="light"] .kbd{ background:#eef2f7; border-color:#d7dee7; color:#1f2937; }
</style>

<style id="vp-light-theme-tweaks">
  /* Button variants: give them solid colors for clarity */
  html[data-theme="light"] .btn-brand,
  html[data-theme="light"] .btn-primary{
    background: var(--accent);
    color: #ffffff;
    border-color: transparent;
  }
  html[data-theme="light"] .btn-ok{
    background: var(--ok);
    color:#ffffff;
    border-color: transparent;
  }
  html[data-theme="light"] .btn-warn{
    background: var(--warn);
    color:#ffffff;
    border-color: transparent;
  }
  html[data-theme="light"] .btn-danger{
    background: var(--danger);
    color:#ffffff;
    border-color: transparent;
  }
  html[data-theme="light"] .btn-brand{ background: var(--brand); }
  html[data-theme="light"] .btn:hover{ filter:none; opacity:.96 }
  html[data-theme="light"] .btn:focus-visible{
    outline: 2px solid var(--accent);
    outline-offset: 2px;
  }

  /* Pills (e.g., thread author badges) */
  html[data-theme="light"] .pill{
    background:#121826;
    color:#f8fafc;
    border:0;
  }

  /* Section headings & dividers */
  html[data-theme="light"] h2, 
  html[data-theme="light"] h3{
    color:#0e1623;
  }
  html[data-theme="light"] hr{
    border:0;
    border-top:1px solid var(--border);
  }

  /* PO list hover cue */
  html[data-theme="light"] .accordion-item:hover{
    box-shadow: 0 2px 6px rgba(16,24,40,.08), 0 8px 18px rgba(16,24,40,.08);
  }

  /* Dense chip layout */
  html[data-theme="light"] .chip{ padding: .2rem .5rem; }

  /* Softer red for 'Label not accepted' style (uses .tag.block) */
  html[data-theme="light"] .tag.block{
    background:#fdecef;
    border-color:#f5c6cf;
    color:#7f1d1d;
  }
</style>


<style id="vp-light-warm-theme">
  /* Warm Light theme (paper/sepia, low glare) */
  html[data-theme="light-warm"]{
    --bg:#f6f2ea;            /* warm paper tone */
    --panel:#fffdf8;         /* slightly warm panel */
    --muted:#f7f4ee;
    --text:#0e141a;          /* deep neutral */
    --sub:#5b5750;
    --brand:#16a34a;         /* keep brand green */
    --accent:#1f4fd7;        /* slightly toned blue */
    --warn:#b05305;
    --danger:#b91c1c;
    --ok:#0b8a5b;
    --chip:#fffcf6;
    --border:#e6dfd2;
    --shadow:0 1px 2px rgba(89,69,32,.06),0 4px 12px rgba(89,69,32,.06);
  }
  html[data-theme="light-warm"] body{ background:var(--bg); color:var(--text); }
  html[data-theme="light-warm"] a{ color:var(--accent); }

  html[data-theme="light-warm"] .card,
  html[data-theme="light-warm"] .panel,
  html[data-theme="light-warm"] .sidebar,
  html[data-theme="light-warm"] header,
  html[data-theme="light-warm"] footer,
  html[data-theme="light-warm"] main,
  html[data-theme="light-warm"] section,
  html[data-theme="light-warm"] nav{
    background:var(--panel);
    box-shadow:var(--shadow);
    border-color:var(--border);
  }

  html[data-theme="light-warm"] input,
  html[data-theme="light-warm"] select,
  html[data-theme="light-warm"] textarea{
    background:#fffdf8;
    border:1px solid var(--border);
    color:var(--text);
  }
  html[data-theme="light-warm"] input::placeholder,
  html[data-theme="light-warm"] textarea::placeholder{ color:#7b776f; }

  html[data-theme="light-warm"] .btn{
    background:linear-gradient(180deg,#fffdf8,#f3efe6);
    border:1px solid var(--border);
    color:var(--text);
  }
  html[data-theme="light-warm"] .btn-brand{ background:var(--brand); color:#fff; border-color:transparent; }
  html[data-theme="light-warm"] .btn-primary{ background:var(--accent); color:#fff; border-color:transparent; }
  html[data-theme="light-warm"] .btn-ok{ background:var(--ok); color:#fff; border-color:transparent; }
  html[data-theme="light-warm"] .btn-warn{ background:var(--warn); color:#fff; border-color:transparent; }
  html[data-theme="light-warm"] .btn-danger{ background:var(--danger); color:#fff; border-color:transparent; }

  html[data-theme="light-warm"] .tag{ background:#fff8ee; border:1px solid #eadfcd; color:#3a332b; }
  html[data-theme="light-warm"] .tag.ok{ background:#ecfaf3; border-color:#c4e9d7; color:#166534; }
  html[data-theme="light-warm"] .tag.warn{ background:#fff1e0; border-color:#f1d1a8; color:#8a4b0b; }
  html[data-theme="light-warm"] .tag.block{ background:#fee8ea; border-color:#f3c3cc; color:#7f1d1d; }

  html[data-theme="light-warm"] .table th{ background:#f5efe4; color:#1e272f; border-bottom:1px solid var(--border); }
  html[data-theme="light-warm"] .table tr:nth-child(even) td{ background:#fffaf3; }
  html[data-theme="light-warm"] .accordion-item{ background:#fffdf8; border:1px solid var(--border); box-shadow:var(--shadow); }
  html[data-theme="light-warm"] .chip{ background:var(--chip); border:1px solid var(--border); color:var(--sub); }
  html[data-theme="light-warm"] .pill{ background:#1a1f2a; color:#fffaf0; border:0; }
</style>


<style id="vp-density-styles">
  /* Compact density reduces vertical rhythm by ~14% */
  html[data-density="compact"] .btn{ padding:6px 10px; font-size:12px; border-radius:.5rem; }
  html[data-density="compact"] .chip{ padding:.15rem .4rem; font-size:12px; }
  html[data-density="compact"] .pill{ padding:.2rem .5rem; font-size:12px; }
  html[data-density="compact"] .input, 
  html[data-density="compact"] select, 
  html[data-density="compact"] textarea{ padding:6px 8px; font-size:13px; }
  html[data-density="compact"] .accordion-item{ margin:8px 0; border-radius:.8rem; }
  html[data-density="compact"] .accordion-head{ padding:10px 14px; }
  html[data-density="compact"] .accordion-body{ padding:12px 14px; }
  html[data-density="compact"] .card, 
  html[data-density="compact"] .panel{ padding:12px; }
  html[data-density="compact"] .table td, 
  html[data-density="compact"] .table th{ padding:8px 10px; }
  html[data-density="compact"] h2{ margin:10px 0 8px; }
  html[data-density="compact"] h3{ margin:8px 0 6px; }
  html[data-density="compact"] .section{ margin:10px 0; }
</style>


<style id="vp-emerald-theme">
  /* Emerald (green dark) theme */
  html[data-theme="emerald"]{
    --bg:#0b2a22;            /* deep green base */
    --bg2:#10362b;           /* secondary for gradients */
    --panel:#104033;         /* panel surface */
    --muted:#0f372c;         /* muted fills */
    --text:#e9fff5;          /* primary text */
    --sub:#bfe8d4;           /* secondary text */
    --brand:#22c55e;         /* emerald */
    --accent:#34d399;        /* accent green */
    --warn:#f59e0b;          /* amber */
    --danger:#ef4444;        /* red */
    --ok:#10b981;            /* success */
    --chip:#0d2f26;
    --border:#1d8a68;        /* card borders */
    --glow:#3af29d;          /* subtle neon for outlines */
    --shadow:0 1px 2px rgba(0,0,0,.35),0 8px 24px rgba(0,0,0,.35);
  }

  html[data-theme="emerald"] body{
    background: radial-gradient(1000px 600px at 20% -10%, var(--bg2), transparent) , 
                radial-gradient(800px 500px at 100% 0%, #0c3a2d55, transparent),
                var(--bg);
    color: var(--text);
  }

  html[data-theme="emerald"] a{ color: var(--accent); }

  /* Panels / containers */
  html[data-theme="emerald"] .card,
  html[data-theme="emerald"] .panel,
  html[data-theme="emerald"] .sidebar,
  html[data-theme="emerald"] header,
  html[data-theme="emerald"] footer,
  html[data-theme="emerald"] main,
  html[data-theme="emerald"] section,
  html[data-theme="emerald"] nav{
    background: var(--panel);
    color: var(--text);
    border: 1px solid var(--border);
    box-shadow: var(--shadow);
  }

  /* Headings get a soft emerald tint */
  html[data-theme="emerald"] h1, 
  html[data-theme="emerald"] h2, 
  html[data-theme="emerald"] h3{
    color:#a7f3c6;
  }

  /* Inputs */
  html[data-theme="emerald"] input,
  html[data-theme="emerald"] select,
  html[data-theme="emerald"] textarea{
    background:#0e332a;
    border:1px solid #1a5e49;
    color:var(--text);
  }
  html[data-theme="emerald"] input::placeholder,
  html[data-theme="emerald"] textarea::placeholder{ color:#91cbb0; }

  /* Buttons */
  html[data-theme="emerald"] .btn{ 
    background: linear-gradient(180deg, #165a45, #114a39);
    border:1px solid #1b7b5c;
    color:#ecfdf5;
  }
  html[data-theme="emerald"] .btn-brand{ background: var(--brand); color:#052e23; border-color:transparent; }
  html[data-theme="emerald"] .btn-primary{ background: #1f9e6d; color:#052e23; border-color:transparent; }
  html[data-theme="emerald"] .btn-ok{ background: var(--ok); color:#052e23; border-color:transparent; }
  html[data-theme="emerald"] .btn-warn{ background: var(--warn); color:#241a02; border-color:transparent; }
  html[data-theme="emerald"] .btn-danger{ background: var(--danger); color:#2a0b0b; border-color:transparent; }
  html[data-theme="emerald"] .btn:hover{ filter:none; opacity:.95 }
  html[data-theme="emerald"] .btn:focus-visible{ outline:2px solid var(--glow); outline-offset:2px; }

  /* Tags */
  html[data-theme="emerald"] .tag{
    background:#0c342a;
    border:1px solid #1f6f56;
    color:#d7fbec;
  }
  html[data-theme="emerald"] .tag.ok{ background:#0f3b2f; border-color:#2cc98e; color:#a7f3c6; }
  html[data-theme="emerald"] .tag.warn{ background:#3b2e0f; border-color:#e9b15b; color:#ffd79a; }
  html[data-theme="emerald"] .tag.block{ background:#3b1216; border-color:#f08a95; color:#fecdd3; }

  /* Chips */
  html[data-theme="emerald"] .chip{
    background: var(--chip);
    border: 1px solid var(--border);
    color: var(--sub);
  }

  /* Tables and accordion */
  html[data-theme="emerald"] .table th{ background:#123b30; color:#d9fff0; border-bottom:1px solid var(--border); }
  html[data-theme="emerald"] .table tr:nth-child(even) td{ background:#0f332a; }
  html[data-theme="emerald"] .accordion-item{ background:#0f3a2f; border:1px solid var(--border); box-shadow: var(--shadow); }
  html[data-theme="emerald"] .accordion-item:hover{ box-shadow: 0 2px 8px rgba(0,0,0,.4), 0 10px 28px rgba(0,0,0,.35); }

  /* Fancy outline for hero/intro blocks if present */
  html[data-theme="emerald"] .panel.hero, 
  html[data-theme="emerald"] .card.hero{
    box-shadow: 0 0 0 1px var(--glow), inset 0 0 0 1px rgba(255,255,255,.03), var(--shadow);
    border-radius: 18px;
  }
</style>





<style id="vp-promo-login">
  #loginPromo .section-title{ font-size:1.25rem; font-weight:700; margin-bottom:.35rem; }
  #loginPromo .promo-list{ margin: .25rem 0 .5rem 1.1rem; padding:0; }
  #loginPromo .promo-list li{ margin:.4rem 0; line-height:1.45; }
  #loginPromo .promo-cta{ text-align:right; margin-top:.35rem; color:var(--sub); font-size:.95rem; }
  /* Slightly larger text on wider screens */
  @media (min-width: 1100px){
    #loginPromo .section-title{ font-size:1.35rem; }
    #loginPromo .promo-list li{ margin:.5rem 0; }
  }
</style>

<style>
/* === SysAdmin-only nav CSS (defensive) === */
body[data-role="Sys Admin"] .nav [data-tab]:not([data-tab="sysadmin"]){ display:none !important; }
body[data-role="Sys Admin"] .nav button, 
body[data-role="Sys Admin"] .nav a { display:none !important; }
body[data-role="Sys Admin"] .nav [data-tab="sysadmin"],
body[data-role="Sys Admin"] .nav .logout-btn,
body[data-role="Sys Admin"] .nav button.logout,
body[data-role="Sys Admin"] .nav a.logout { display:block !important; }
</style>
</head>
<body>
<div id="app"></div>

<script>
(function(){
  "use strict";
  function escapeHTML(str) {
    if (typeof str !== 'string') return str;
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
  }

  // ---------- Utilities ----------
// === Counterparty helpers (PO display) ===
function counterpartyCompanyId(po, meId = session.companyId){
  if(!po) return null;
  const buyer = po.buyerId || po.buyer_id || po.buyer;
  const supplier = (po.supplierId ?? po.sellerId ?? po.supplier_id ?? po.supplier);
  if(meId === buyer) return supplier;
  if(meId === supplier) return buyer;
  return supplier && supplier !== meId ? supplier : buyer;
}
function counterpartyName(po, meId = session.companyId){
  const otherId = counterpartyCompanyId(po, meId);
  const other = otherId ? companyById(otherId) : null;
  return other ? other.name : 'Unknown';
}


// === Traceability Fallbacks ===
// If a PO has missing/empty trace, infer a sensible default from buyer/supplier types and items.
function ensureTrace(p){
  try{
    if(!p || (p.trace && Object.keys(p.trace||{}).length>0)) return p;
    const buyer = companyById(p.buyerId);
    const supplier = companyById(p.supplierId);
    const bt = buyer ? buyer.type : null;
    const st = supplier ? supplier.type : null;

    // infer chain order based on company types
    let chain = [];
    if (st==='Coop' && bt==='Processor'){ chain = [supplier.id, buyer.id]; }
    else if (st==='Processor' && bt==='Importer'){ chain = [supplier.id, buyer.id]; }
    else if (st==='Coop' && bt==='Importer'){ chain = [supplier.id, 'C_PRO', buyer.id]; } // fallback via processor
    else { chain = [supplier?.id||'C_COO1','C_PRO', buyer?.id||'C_IMP']; }

    // build simple lots from items (split first item qty 60/40 as two lots)
    const total = (p.items||[]).reduce((a,it)=> a + (Number(it.qty)||0), 0);
    const lotA = Math.round(total * 0.6) || (total||100)/2;
    const lotB = Math.max(0, total - lotA);
    const lots = [{id:'LOT-A', qty: lotA}, {id:'LOT-B', qty: lotB}];

    // basic geo path string (can be refined later)
    const geo = (function(){
      const map = {
        'C_COO1':'16.07,102.67', 'C_COO2':'14.22,100.88',
        'C_PRO':'13.75,100.50', 'C_IMP':'52.37,4.90'
      };
      const points = chain.map(c=> map[c] || map[c?.id] || '—').filter(Boolean);
      return points.join(' → ');
    })();

    p.trace = { lots, chain, geo };
  }catch(e){ /* no-op */ }
  return p;
}
// === BEGIN: AUTO-APPLIED TAB RULES ===
const TAB_RULES = {
  "Importer": {
    "Procurement Manager": [
      "Dashboard",
      "Purchase Orders",
      "Documents",
      "Wallet",
      "Business Partners",
      "Invitations"
    ],
    "QA / Label Manager": [
      "Dashboard",
      "Purchase Orders",
      "Documents",
      "Business Partners"
    ],
    "Logistics Coordinator": [
      "Purchase Orders",
      "Documents",
      "Wallet",
      "Business Partners",
      "Invitations"
    ],
    "Finance / Wallet Admin": [
      "Wallet"
    ],
    "Sys Admin": [
      "Sys Admin"
    ]
  },
  "Processor": {
    "Export Manager": [
      "Dashboard",
      "Purchase Orders",
      "Documents",
      "Wallet",
      "Business Partners",
      "Invitations"
    ],
    "Production Manager": [
      "Dashboard",
      "Purchase Orders",
      "Documents",
      "Wallet",
      "Business Partners",
      "Invitations"
    ],
    "Account Manager": [
      "Dashboard",
      "Purchase Orders",
      "Documents",
      "Wallet",
      "Business Partners",
      "Invitations"
    ],
    "Quality Manager": [
      "Dashboard",
      "Purchase Orders",
      "Documents"
    ],
    "Compliance Manager": [
      "Dashboard",
      "Purchase Orders",
      "Documents"
    ],
    "Logistics Manager": ["Purchase Orders",
      
      "Documents",
      "Wallet",
      "Business Partners",
      "Invitations"
    ],
    "Finance / Wallet Admin": [
      "Wallet",
      "Business Partners"
    ],
    "Sys Admin": [
      "Sys Admin"
    ]
  },
  "Coop": {
    "Sales Manager": [
      "Dashboard",
      "Purchase Orders",
      "Documents",
      "Wallet",
      "Business Partners",
      "Invitations"
    ],
    "QA Liaison": [
      "Purchase Orders",
      "Documents",
      "Business Partners"
    ],
    "Operations Manager": [
      "Dashboard",
      "Purchase Orders",
      "Documents",
      "Wallet",
      "Business Partners",
      "Invitations"
    ],
    "Finance / Wallet Admin": [
      "Wallet"
    ],
    "Sys Admin": [
      "Sys Admin"
    ]
  }
};
// Helper: given company type (Importer/Processor/Coop) and role string, return a Set of allowed tabs
function allowedTabsFor(companyType, role){
  try{
    const ct = canonCompanyType(companyType);
    const rr = canonRoleName(role);
    const map = TAB_RULES[ct];
    if(!map) return new Set(); // strict: unknown company -> deny all
    const list = map[rr] || [];
    return new Set(list);
  }catch(e){ return new Set(); }
}
// === END: AUTO-APPLIED TAB RULES ===

// --- Canonical company/role normalizers ---
const ROLE_ALIASES = {
  "sys admin": "Sys Admin",
  "system admin": "Sys Admin",
  "finance/wallet admin": "Finance / Wallet Admin",
  "finance wallet admin": "Finance / Wallet Admin",
  "qa/label manager": "QA / Label Manager",
  "qa label manager": "QA / Label Manager",
  "procurement manager": "Procurement Manager",
  "logistics coordinator": "Logistics Coordinator",
  "export manager": "Export Manager",
  "production manager": "Production Manager",
  "quality manager": "Quality Manager",
  "compliance manager": "Compliance Manager",
  "account manager": "Account Manager",
  "sales manager": "Sales Manager",
  "operations manager": "Operations Manager"
};
function canonCompanyType(t){
  if(!t) return null;
  const s = String(t).trim().toLowerCase();
  if (s.includes('import')) return 'Importer';
  if (s.includes('process')) return 'Processor';
  if (s.includes('coop')) return 'Coop';
  if (s.includes('co-op') || s.includes('cooperative')) return 'Coop';
  return t;
}
function canonRoleName(r){
  if(!r) return null;
  const s = String(r).replace(/\s*\/\s*/g,'/').replace(/\s+/g,' ').trim().toLowerCase();
  const aliased = ROLE_ALIASES[s];
  if (aliased) return aliased;
  // Title case fallback
  return r;
}

// --- Canonical tab id mapping (UI label <-> data-tab) ---
const TAB_NAME_TO_ID = {
  "Dashboard": "dashboard",
  "Purchase Orders": "pos",
  "Documents": "documents",
  "Wallet": "wallet",
  "Business Partners": "partners",
  "Invitations": "invitations",
  "Sys Admin": "sysadmin"
};
function canonTabId(s){
  if(!s) return "";
  const raw = String(s).trim();
  if (TAB_NAME_TO_ID[raw]) return TAB_NAME_TO_ID[raw];
  const low = raw.toLowerCase().replace(/[\s_-]+/g,'');
  if (low === 'po' || low === 'purchaseorders') return 'pos';
  if (low === 'sysadmin' || low === 'systemadmin' || low === 'sysadministration') return 'sysadmin';
  if (low === 'businesspartners' || low === 'partners') return 'partners';
  const known = ['dashboard','pos','documents','wallet','partners','invitations','sysadmin'];
  if (known.includes(String(s).toLowerCase())) return String(s).toLowerCase();
  return raw;
}
// Context helper to resolve current company type and role for the logged-in user
function _vpCurrentContext(){
  try{
    const sess = (typeof session!=='undefined' && session && session.userId) ? session
                : (window.session ? window.session : (state && state.session ? state.session : null));
    let user = null;
    if(sess && sess.userId){
      user = (state.users||[]).find(u=>u.id===sess.userId) || null;
    } else if (state && state.users && state.users.length){
      user = state.users.find(u=>u.status==='Active') || state.users[0];
    }
    if(!user) return { companyType: null, role: null, companyId: null };
    const company = (state.companies||[]).find(c=>c.id===user.companyId) || null;
    const companyType = company ? company.type : null;
    return { companyType, role: user.role, companyId: user.companyId, user };
  }catch(e){
    return { companyType: null, role: null, companyId: null };
  }
}

// Predicate used by nav/tab renderers

function isTabAllowed(tabLabel){
  const ctx = _vpCurrentContext();
  const ct = canonCompanyType(ctx.companyType);
  const rr = canonRoleName(ctx.role);
  if(!ct || !rr) return false; // strict: hide if unknown
  const allowed = allowedTabsFor(ct, rr);
  if(allowed.size===0) return false;
  const cid = canonTabId(tabLabel);
  const allowedIds = new Set(Array.from(allowed).map(canonTabId));
  return allowedIds.has(cid);
}

  const $ = (sel, root=document) => root.querySelector(sel);
  const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
  function toast(msg, kind='ok'){
    const el = document.createElement('div');
    el.className = 'toast ' + (kind==='warn'?'warn':kind==='err'?'err':'ok');
    el.textContent = msg;
    document.body.appendChild(el);
    setTimeout(()=>{ el.remove(); }, 2600);
  }
  function save(){ localStorage.setItem('vp', JSON.stringify(state)); }
  function load(){
    try{
      const raw = localStorage.getItem('vp');
      if(!raw) return null;
      return JSON.parse(raw);
    }catch(e){ return null; }
  }
  function deepClone(x){ return JSON.parse(JSON.stringify(x)); }

  // ---------- Missing Functions (Fixed) ----------
  function now() {
    return new Date().toISOString().slice(0, 16).replace('T', ' ');
  }

  function shortId(prefix='P') {
    return prefix + Math.random().toString(36).slice(2, 8).toUpperCase();
  }

  async function hashDataURL(dataUrl) {
    try {
      const encoder = new TextEncoder();
      const data = encoder.encode(dataUrl);
      let hash = 0;
      for (let i = 0; i < data.length; i++) {
        const char = data[i];
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash;
      }
      return Math.abs(hash).toString(16).slice(0, 8);
    } catch (e) {
      return Math.random().toString(36).slice(2, 10);
    }
  }

  // ---------- Seeding ----------
  const seed = {
    companies: [
      {id:'C_IMP', name:'EU Asian Importers', type:'Importer', city:'Amsterdam'},
      {id:'C_PRO', name:'Bangkok Chili Co., Ltd.', type:'Processor', city:'Bangkok'},
      {id:'C_COO1', name:'NE Thai Herb Producer', type:'Coop', city:'Udon Thani'},
      {id:'C_COO2', name:'Central Thai Organic', type:'Coop', city:'Ayutthaya'},
    ],
    logisticsProviders: [
      {id:'LOG_TH1', name:'Thai Express Logistics', region:'Thailand', city:'Bangkok', specialty:'Ground Freight - Regular', services:['domestic_ground','port_transfer']},
      {id:'LOG_TH2', name:'Bangkok Cold Chain Services', region:'Thailand', city:'Bangkok', specialty:'Ground Freight - Refrigerated', services:['refrigerated_ground','cold_storage']},
      {id:'LOG_TH3', name:'Siam Ocean Freight Lines', region:'Thailand', city:'Laem Chabang', specialty:'Ocean Freight', services:['ocean_freight','container_shipping']},
      {id:'LOG_TH4', name:'Mekong Transport Solutions', region:'Thailand', city:'Chiang Mai', specialty:'Ground Freight - Regular', services:['domestic_ground','rural_delivery']},
      {id:'LOG_TH5', name:'Thai Refrigerated Express', region:'Thailand', city:'Surat Thani', specialty:'Ground Freight - Refrigerated', services:['refrigerated_ground','fresh_transport']},
      {id:'LOG_EU1', name:'Rotterdam Port Logistics', region:'EU', city:'Rotterdam', specialty:'Ocean Freight', services:['ocean_freight','port_operations','container_handling']},
      {id:'LOG_EU2', name:'EuroFreight Solutions', region:'EU', city:'Hamburg', specialty:'Ground Freight - Regular', services:['eu_ground','distribution','warehousing']},
      {id:'LOG_EU3', name:'Antwerp Cold Storage Transport', region:'EU', city:'Antwerp', specialty:'Ground Freight - Refrigerated', services:['refrigerated_ground','cold_storage','eu_distribution']},
      {id:'LOG_EU4', name:'Amsterdam Logistics Hub', region:'EU', city:'Amsterdam', specialty:'Ground Freight - Regular', services:['eu_ground','last_mile','distribution']},
      {id:'LOG_EU5', name:'North Sea Freight Services', region:'EU', city:'Hamburg', specialty:'Ocean Freight', services:['ocean_freight','short_sea','feeder_services']},
      {id:'LOG_EU6', name:'Rotterdam Refrigerated Transport', region:'EU', city:'Rotterdam', specialty:'Ground Freight - Refrigerated', services:['refrigerated_ground','cold_chain','eu_distribution']}
    ],
    users: [
      {id:'U001', companyId:'C_IMP', email:'j.anderson@euasian.com', name:'James Anderson', role:'Procurement Manager', status:'Active', lastLogin:now(), createdAt:now(), mfaEnabled:true, adminLevel:'None'},
      {id:'U002', companyId:'C_IMP', email:'m.schmidt@euasian.com', name:'Maria Schmidt', role:'QA / Label Manager', status:'Active', lastLogin:now(), createdAt:now(), mfaEnabled:false, adminLevel:'None'},
      {id:'U003', companyId:'C_IMP', email:'r.patel@euasian.com', name:'Raj Patel', role:'Finance / Wallet Admin', status:'Active', lastLogin:now(), createdAt:now(), mfaEnabled:true, adminLevel:'None'},
      {id:'U004', companyId:'C_IMP', email:'admin@euasian.com', name:'System Admin', role:'Sys Admin', status:'Active', lastLogin:now(), createdAt:now(), mfaEnabled:true, adminLevel:'Super'},
      {id:'U005', companyId:'C_IMP', email:'s.dupont@euasian.com', name:'Sophie Dupont', role:'Procurement Manager', status:'Suspended', lastLogin:now(), createdAt:now(), mfaEnabled:false, adminLevel:'None'},
      {id:'U006', companyId:'C_PRO', email:'s.tanaka@bkc.co.th', name:'Satoshi Tanaka', role:'Export Manager', status:'Active', lastLogin:now(), createdAt:now(), mfaEnabled:true, adminLevel:'None'},
      {id:'U007', companyId:'C_PRO', email:'a.wong@bkc.co.th', name:'Anong Wong', role:'Quality Manager', status:'Active', lastLogin:now(), createdAt:now(), mfaEnabled:true, adminLevel:'None'},
      {id:'U008', companyId:'C_PRO', email:'c.somchai@bkc.co.th', name:'Chai Somchai', role:'Logistics Manager', status:'Active', lastLogin:now(), createdAt:now(), mfaEnabled:false, adminLevel:'None'},
      {id:'U009', companyId:'C_PRO', email:'p.chen@bkc.co.th', name:'Priya Chen', role:'Finance / Wallet Admin', status:'Active', lastLogin:now(), createdAt:now(), mfaEnabled:true, adminLevel:'None'},
      {id:'U010', companyId:'C_PRO', email:'admin@bkc.co.th', name:'Processor Admin', role:'Sys Admin', status:'Active', lastLogin:now(), createdAt:now(), mfaEnabled:true, adminLevel:'Standard'},
      {id:'U011', companyId:'C_PRO', email:'t.nguyen@bkc.co.th', name:'Tuan Nguyen', role:'Production Manager', status:'Suspended', lastLogin:now(), createdAt:now(), mfaEnabled:false, adminLevel:'None'},
      {id:'U012', companyId:'C_COO1', email:'n.pranee@nethp.co.th', name:'Niran Pranee', role:'Sales Manager', status:'Active', lastLogin:now(), createdAt:now(), mfaEnabled:false, adminLevel:'None'},
      {id:'U013', companyId:'C_COO1', email:'k.somsak@nethp.co.th', name:'Kamala Somsak', role:'QA Liaison', status:'Active', lastLogin:now(), createdAt:now(), mfaEnabled:true, adminLevel:'None'},
      {id:'U014', companyId:'C_COO1', email:'f.bounma@nethp.co.th', name:'Fon Bounma', role:'Finance / Wallet Admin', status:'Active', lastLogin:now(), createdAt:now(), mfaEnabled:false, adminLevel:'None'},
      {id:'U015', companyId:'C_COO1', email:'admin@nethp.co.th', name:'Coop Admin', role:'Sys Admin', status:'Active', lastLogin:now(), createdAt:now(), mfaEnabled:true, adminLevel:'Limited'},
      {id:'U016', companyId:'C_COO2', email:'m.surin@cto.co.th', name:'Malee Surin', role:'Sales Manager', status:'Active', lastLogin:now(), createdAt:now(), mfaEnabled:true, adminLevel:'None'},
      {id:'U017', companyId:'C_COO2', email:'u.kanya@cto.co.th', name:'Ubon Kanya', role:'QA Liaison', status:'Active', lastLogin:now(), createdAt:now(), mfaEnabled:false, adminLevel:'None'},
      {id:'U018', companyId:'C_COO2', email:'v.chinda@cto.co.th', name:'Vimala Chinda', role:'Finance / Wallet Admin', status:'Suspended', lastLogin:now(), createdAt:now(), mfaEnabled:true, adminLevel:'None'},
      {id:'U019', companyId:'C_COO2', email:'admin@cto.co.th', name:'Readonly Admin', role:'Sys Admin', status:'Active', lastLogin:now(), createdAt:now(), mfaEnabled:true, adminLevel:'Limited'},
      {id:'U020', companyId:'C_IMP', email:'l.admin@euasian.com', name:'Limited Admin', role:'Sys Admin', status:'Active', lastLogin:now(), createdAt:now(), mfaEnabled:false, adminLevel:'Limited'},
      {id:'U021', companyId:'C_IMP', email:'l.vanderberg@euasian.com', name:'Lars van der Berg', role:'Logistics Coordinator', status:'Active', lastLogin:now(), createdAt:now(), mfaEnabled:true, adminLevel:'None'},
      {id:'U022', companyId:'C_COO1', email:'w.transport@nethp.co.th', name:'Wichai Sompong', role:'Operations Manager', status:'Active', lastLogin:now(), createdAt:now(), mfaEnabled:false, adminLevel:'None'},
      {id:'U023', companyId:'C_COO2', email:'s.logistics@cto.co.th', name:'Siriporn Thanakit', role:'Operations Manager', status:'Active', lastLogin:now(), createdAt:now(), mfaEnabled:true, adminLevel:'None'}
    ],
    roles: {
      Importer: ['Procurement Manager','QA / Label Manager','Logistics Coordinator','Finance / Wallet Admin','Sys Admin'],
      Processor: ['Export Manager', 'Account Manager', 'Production Manager', 'Quality Manager','Compliance Manager', 'Logistics Manager','Finance / Wallet Admin','Sys Admin'],
      Coop: ['Sales Manager','QA Liaison', 'Operations Manager','Finance / Wallet Admin','Sys Admin']
    },
    companyDocuments: [
      {id:'DOC001', companyId:'C_IMP', name:'EORI Registration Certificate', category:'Regulatory', type:'EORI', fileHash:'abc123def456', uploadedBy:'U002', uploadedAt:now(), expiresAt: new Date(Date.now()+86400000*730).toISOString(), status:'Valid', tags:['EU-Required', 'Import-Essential']},
      {id:'DOC002', companyId:'C_IMP', name:'Import License 2025', category:'Regulatory', type:'Import License', fileHash:'f7a2b3c4d5e6', uploadedBy:'U002', uploadedAt:now(), expiresAt: new Date(Date.now()+86400000*365).toISOString(), status:'Valid'},
      {id:'DOC003', companyId:'C_IMP', name:'Cargo Insurance Policy', category:'Operational', type:'Insurance', fileHash:'g1h2i3j4k5l6', uploadedBy:'U021', uploadedAt:now(), expiresAt: new Date(Date.now()+86400000*180).toISOString(), status:'Valid'},
      {id:'DOC004', companyId:'C_PRO', name:'GMP Certificate', category:'Quality & Safety', type:'GMP', fileHash:'m7n8o9p0q1r2', uploadedBy:'U007', uploadedAt:now(), expiresAt: new Date(Date.now()+86400000*25).toISOString(), status:'Expiring Soon'},
      {id:'DOC005', companyId:'C_PRO', name:'HACCP Plan 2025', category:'Quality & Safety', type:'HACCP', fileHash:'s3t4u5v6w7x8', uploadedBy:'U007', uploadedAt:now(), expiresAt: new Date(Date.now()+86400000*180).toISOString(), status:'Valid'},
      {id:'DOC006', companyId:'C_PRO', name:'Establishment Approval Cert', category:'Regulatory', type:'Establishment Approval', fileHash:'y9z0a1b2c3d4', uploadedBy:'U007', uploadedAt:now(), expiresAt: new Date(Date.now()+86400000*365).toISOString(), status:'Valid'},
      {id:'DOC007', companyId:'C_COO1', name:'Organic Certificate', category:'Sustainability', type:'Organic', fileHash:'e5f6g7h8i9j0', uploadedBy:'U013', uploadedAt:now(), expiresAt: new Date(Date.now()+86400000*120).toISOString(), status:'Valid'},
      {id:'DOC008', companyId:'C_COO1', name:'Global GAP Certificate', category:'Sustainability', type:'Global GAP', fileHash:'k1l2m3n4o5p6', uploadedBy:'U013', uploadedAt:now(), expiresAt: new Date(Date.now()+86400000*200).toISOString(), status:'Valid'},
      {id:'DOC009', companyId:'C_COO2', name:'Organic Certificate', category:'Sustainability', type:'Organic', fileHash:'q7r8s9t0u1v2', uploadedBy:'U017', uploadedAt:now(), expiresAt: new Date(Date.now()-86400000*30).toISOString(), status:'Expired'}
    ],
    documentCategories: {
      'Regulatory': ['EORI', 'TRACES', 'Establishment Approval', 'Import License'],
      'Quality & Safety': ['GMP', 'HACCP', 'ISO9001', 'ISO22000'],
      'Sustainability': ['Organic', 'FairTrade', 'Global GAP', 'Rainforest Alliance'],
      'Operational': ['Insurance', 'Bill of Lading', 'Commercial Invoice', 'Certificate of Origin'],
      'Product-Specific': ['Test Results', 'Specifications', 'Nutritional Analysis', 'Allergen Declaration']
    },
    certs: [
      {companyId:'C_IMP', type:'EORI', expiresAt: new Date(Date.now()+86400000*365).toISOString()},
      {companyId:'C_IMP', type:'ISO9001', expiresAt: new Date(Date.now()+86400000*180).toISOString()},
      {companyId:'C_PRO', type:'GMP', expiresAt: new Date(Date.now()+86400000*25).toISOString()},
      {companyId:'C_PRO', type:'HACCP', expiresAt: new Date(Date.now()+86400000*180).toISOString()},
      {companyId:'C_COO1', type:'Organic', expiresAt: new Date(Date.now()+86400000*120).toISOString()},
      {companyId:'C_COO1', type:'FairTrade', expiresAt: new Date(Date.now()+86400000*90).toISOString()},
      {companyId:'C_COO2', type:'Organic', expiresAt: new Date(Date.now()-86400000*30).toISOString()},
      {companyId:'C_COO2', type:'FairTrade', expiresAt: new Date(Date.now()+86400000*15).toISOString()}
    ],
    wallets: [
      {companyId:'C_IMP', balance:3200, ledger:[{ts:now(), kind:'Received', detail:'Initial VERI allocation', amount:3200}]},
      {companyId:'C_PRO', balance:2800, ledger:[{ts:now(), kind:'Received', detail:'Initial VERI allocation', amount:2800}]},
      {companyId:'C_COO1', balance:1200, ledger:[{ts:now(), kind:'Received', detail:'Initial VERI allocation', amount:1200}]},
      {companyId:'C_COO2', balance:950, ledger:[{ts:now(), kind:'Received', detail:'Initial VERI allocation', amount:950}]}
    ],
    invitations: [
      {id:'I1', fromCompanyId:'C_IMP', fromRole:'Procurement Manager', toCompanyId:'C_PRO', toType:'Processor', status:'Pending', createdAt: now()},
      {id:'I2', fromCompanyId:'C_PRO', fromRole:'Account Manager', toCompanyId:'C_COO1', toType:'Coop', status:'Accepted', createdAt: now(), decidedAt: now()},
      {id:'I3', fromCompanyId:'C_PRO', fromRole:'Account Manager', toCompanyId:'C_COO2', toType:'Coop', status:'Pending', createdAt: now()}
    ],
    partners: [
      {id:'E1', aId:'C_IMP', bId:'C_PRO', status:'Accepted', directionForA:'Supplier', source:'invitation', createdAt: now()},
      {id:'E2', aId:'C_PRO', bId:'C_COO1', status:'Accepted', directionForA:'Supplier', source:'invitation', createdAt: now()}
    ],
    labels: [
      {poId:'P2003', status:'Accepted'}, {poId:'P1005', status:'Accepted'}, {poId:'P1007', status:'Accepted'}
    ],
    awards: [
      {poId:'P1009', type:'organic', amount:1000, status:'Completed', awardedAt: now()}, {poId:'P1010', type:'fairTrade', amount:800, status:'Completed', awardedAt: now()}
    ],
    walletAuditLog: [],
    auditLog: [],
    securityEvents: [],
    pos: [
      { id:'P1001', buyerId:'C_IMP', supplierId:'C_PRO', currency:'EUR', items:[{name:'Sweet Thai Chili Sauce 12x300ml', qty:1200, price:1.7}], total:2040, status:'Open', labelStatus:'Requested', rewards:{organic:1000,fairTrade:1000,rainforest:1000}, docChecklist:[{name:'GMP', state:'Expiring Soon'}], docs:[], thread:[ {author:'C_IMP:Procurement Manager', msg:'Kickoff PO for Q4', ts:now()}, {author:'C_IMP:QA / Label Manager', msg:'Label requested: Standard labeling requirements with nutritional info', ts:now()} ], shipments:[], trace:{ lots:[{id:'LOT-A',qty:600},{id:'LOT-B',qty:600}], chain:['C_COO1','C_PRO','C_IMP'], geo:'16.07,102.67 → 13.75,100.50 → 52.37,4.90' }, createdAt: now(), labelHistory: [ {id:'LBL_REQ001', action:'requested', actor:'C_IMP:QA / Label Manager', timestamp:now(), version:1, requirements:'Standard labeling requirements with nutritional info'} ] },
      { id:'P2001', buyerId:'C_PRO', supplierId:'C_COO1', currency:'THB', items:[{name:'Fresh Lemongrass (kg)', qty:500, price:42}], total:21000, status:'Open', labelStatus:'Not Required', rewards:{organic:800,fairTrade:600}, docChecklist:[{name:'Organic', state:'Valid'}], docs:[], thread:[{author:'C_PRO:Account Manager', msg:'Standard lemongrass order', ts:now()}], shipments:[], trace:{ lots:[{id:'LOT-A',qty:600},{id:'LOT-B',qty:600}], chain:['C_COO1','C_PRO','C_IMP'], geo:'16.07,102.67 → 13.75,100.50 → 52.37,4.90' }, createdAt: now() },
      { id:'P1002', buyerId:'C_IMP', supplierId:'C_PRO', currency:'EUR', items:[{name:'Tom Yum Paste 24x200g', qty:800, price:2.2}], total:1760, status:'Approved', labelStatus:'Accepted', rewards:{organic:1200,fairTrade:800}, docChecklist:[{name:'GMP', state:'Expiring Soon'}, {name:'HACCP', state:'Valid'}], docs:[], thread:[ {author:'C_IMP:Procurement Manager', msg:'Approved tom yum paste order', ts:now()}, {author:'C_PRO:Account Manager', msg:'Thanks, will prepare shipment', ts:now()}, {author:'C_IMP:QA / Label Manager', msg:'Label requested: EU compliant labeling with allergen info', ts:now()}, {author:'C_PRO:Quality Manager', msg:'Label uploaded: Tom_Yum_Label_v2.pdf [a1b2c3d4]', ts:now()}, {author:'C_IMP:QA / Label Manager', msg:'Label accepted: Looks good, meets EU requirements', ts:now()} ], shipments:[], trace:{ lots:[{id:'LOT-A',qty:600},{id:'LOT-B',qty:600}], chain:['C_COO1','C_PRO','C_IMP'], geo:'16.07,102.67 → 13.75,100.50 → 52.37,4.90' }, createdAt: now(), labelHistory: [ {id:'LBL_REQ002', action:'requested', actor:'C_IMP:QA / Label Manager', timestamp:now(), version:1, requirements:'EU compliant labeling with allergen info'}, {id:'LBL_UPL002', action:'uploaded', actor:'C_PRO:Quality Manager', timestamp:now(), version:2, fileName:'Tom_Yum_Label_v2.pdf', fileHash:'a1b2c3d4', fileSize:2048576}, {id:'LBL_ACC002', action:'accepted', actor:'C_IMP:QA / Label Manager', timestamp:now(), version:3, comments:'Looks good, meets EU requirements'} ] },
      { id:'P2002', buyerId:'C_PRO', supplierId:'C_COO2', currency:'THB', items:[{name:'Organic Thai Basil (kg)', qty:300, price:65}], total:19500, status:'Approved', labelStatus:'Not Required', rewards:{organic:1000,fairTrade:600}, docChecklist:[{name:'Organic', state:'Expired'}], docs:[], thread:[ {author:'C_PRO:Account Manager', msg:'Approved basil order', ts:now()}, {author:'C_COO2:Sales Manager', msg:'Will harvest fresh for you', ts:now()} ], shipments:[], trace:{ lots:[{id:'LOT-A',qty:600},{id:'LOT-B',qty:600}], chain:['C_COO1','C_PRO','C_IMP'], geo:'16.07,102.67 → 13.75,100.50 → 52.37,4.90' }, createdAt: now() },
      { id:'P2003', buyerId:'C_PRO', supplierId:'C_COO1', currency:'THB', items:[{name:'Fresh Thai Chilies (kg)', qty:400, price:85}], total:34000, status:'ReadyToShip', labelStatus:'Not Required', rewards:{organic:1000,fairTrade:800}, docChecklist:[{name:'Organic', state:'Valid'}, {name:'FairTrade', state:'Valid'}], docs:[], thread:[ {author:'C_PRO:Account Manager', msg:'QA completed - PASS', ts:now()}, {author:'C_COO1:Sales Manager', msg:'Ready for pickup', ts:now()} ], shipments:[{id:'S1', qty:400, ts:now()}], trace:{ lots:[ {id:'L-CHILI-001', qty:240, source:'Primary Farm'}, {id:'L-CHILI-002', qty:100, source:'Secondary Farm'}, {id:'L-CHILI-003', qty:60, source:'Tertiary Farm'} ], chain:['Primary Farm','Secondary Farm','Tertiary Farm','C_COO1','C_PRO'], geo:'15.87,100.99' }, createdAt: now() },
      { id:'P1003', buyerId:'C_IMP', supplierId:'C_PRO', currency:'EUR', items:[{name:'Green Curry Paste 18x400g', qty:600, price:3.1}], total:1860, status:'Open', labelStatus:'Rejected', rewards:{organic:900,fairTrade:700}, docChecklist:[{name:'GMP', state:'Expiring Soon'}], docs:[], thread:[ {author:'C_PRO:Production Manager', msg:'Batch ready for production', ts:now()}, {author:'C_IMP:QA / Label Manager', msg:'Label requested: Green curry paste labeling with heat level indicator', ts:now()}, {author:'C_PRO:Quality Manager', msg:'Label uploaded: Green_Curry_Label_v1.pdf [x9y8z7w6]', ts:now()}, {author:'C_IMP:QA / Label Manager', msg:'Label rejected: Missing proper heat level warnings and ingredient allergen list format incorrect', ts:now()} ], shipments:[], trace:{ lots:[{id:'LOT-A',qty:600},{id:'LOT-B',qty:600}], chain:['C_COO1','C_PRO','C_IMP'], geo:'16.07,102.67 → 13.75,100.50 → 52.37,4.90' }, createdAt: now(), labelHistory: [ {id:'LBL_REQ003', action:'requested', actor:'C_IMP:QA / Label Manager', timestamp:now(), version:1, requirements:'Green curry paste labeling with heat level indicator'}, {id:'LBL_UPL003', action:'uploaded', actor:'C_PRO:Quality Manager', timestamp:now(), version:2, fileName:'Green_Curry_Label_v1.pdf', fileHash:'x9y8z7w6', fileSize:1536789}, {id:'LBL_REJ003', action:'rejected', actor:'C_IMP:QA / Label Manager', timestamp:now(), version:3, reason:'Missing proper heat level warnings and ingredient allergen list format incorrect', requiresResubmission:true} ] },
      { id:'P1004', buyerId:'C_IMP', supplierId:'C_PRO', currency:'EUR', items:[{name:'Coconut Milk 24x400ml', qty:1000, price:1.5}], total:1500, status:'Shipped', labelStatus:'Accepted', rewards:{organic:800,fairTrade:600}, docChecklist:[{name:'GMP', state:'Expiring Soon'}, {name:'HACCP', state:'Valid'}], docs:[], thread:[ {author:'C_PRO:Logistics Manager', msg:'Shipped via Bangkok Port', ts:now()}, {author:'C_IMP:Procurement Manager', msg:'Tracking received', ts:now()}, {author:'C_IMP:QA / Label Manager', msg:'Label accepted: Perfect coconut milk labeling', ts:now()} ], shipments:[{id:'S1', qty:1000, ts:now(), carrier:'Siam Ocean Freight Lines', logisticsProvider: 'LOG_TH3', tracking:'TL2024001234'}], trace:{ lots:[ {id:'L-COCONUT-001', qty:600, source:'Southern Plantations'}, {id:'L-COCONUT-002', qty:250, source:'Central Farms'}, {id:'L-COCONUT-003', qty:150, source:'Northern Cooperatives'} ], chain:['Southern Plantations','Central Farms','Northern Cooperatives','C_PRO','C_IMP'], geo:'7.89,98.40' }, createdAt: now(), labelHistory: [ {id:'LBL_REQ004', action:'requested', actor:'C_IMP:QA / Label Manager', timestamp:now(), version:1, requirements:'Standard coconut milk labeling'}, {id:'LBL_UPL004', action:'uploaded', actor:'C_PRO:Quality Manager', timestamp:now(), version:2, fileName:'Coconut_Milk_Label.pdf', fileHash:'c0c0nut1', fileSize:1234567}, {id:'LBL_ACC004', action:'accepted', actor:'C_IMP:QA / Label Manager', timestamp:now(), version:3, comments:'Perfect coconut milk labeling'} ] },
      { id:'P2004', buyerId:'C_PRO', supplierId:'C_COO2', currency:'THB', items:[{name:'Kaffir Lime Leaves (kg)', qty:150, price:120}], total:18000, status:'Shipped', labelStatus:'Not Required', rewards:{organic:600,fairTrade:400}, docChecklist:[{name:'Organic', state:'Expired'}], docs:[], thread:[{author:'C_COO2:Sales Manager', msg:'Shipped fresh lime leaves', ts:now()}], shipments:[{id:'S1', qty:150, ts:now(), carrier: 'Local Transport', logisticsProvider: 'LOG_TH4'}], trace:{ lots:[ {id:'L-LIME-001', qty:90, source:'Main Grove'}, {id:'L-LIME-002', qty:37, source:'Hill Grove'}, {id:'L-LIME-003', qty:23, source:'Valley Grove'} ], chain:['Main Grove','Hill Grove','Valley Grove','C_COO2','C_PRO'], geo:'14.22,100.88' }, createdAt: now() },
      { id:'P1005', buyerId:'C_IMP', supplierId:'C_PRO', currency:'EUR', items:[{name:'Pad Thai Sauce 15x350ml', qty:900, price:2.8}], total:2520, status:'Open', labelStatus:'Pending Review', rewards:{organic:1100,fairTrade:900}, docChecklist:[{name:'GMP', state:'Expiring Soon'}], docs:[], thread:[ {author:'C_IMP:QA / Label Manager', msg:'Label requested: Pad Thai sauce with authentic recipe indicator', ts:now()}, {author:'C_PRO:Quality Manager', msg:'Label uploaded: Pad_Thai_Sauce_Label.pdf [pt123456]', ts:now()} ], shipments:[], trace:{ lots:[{id:'LOT-A',qty:600},{id:'LOT-B',qty:600}], chain:['C_COO1','C_PRO','C_IMP'], geo:'16.07,102.67 → 13.75,100.50 → 52.37,4.90' }, createdAt: now(), labelHistory: [ {id:'LBL_REQ005', action:'requested', actor:'C_IMP:QA / Label Manager', timestamp:now(), version:1, requirements:'Pad Thai sauce with authentic recipe indicator'}, {id:'LBL_UPL005', action:'uploaded', actor:'C_PRO:Quality Manager', timestamp:now(), version:2, fileName:'Pad_Thai_Sauce_Label.pdf', fileHash:'pt123456', fileSize:1987654} ] },
      { id:'P1006', buyerId:'C_IMP', supplierId:'C_PRO', currency:'EUR', items:[{name:'Massaman Curry Paste 20x250g', qty:500, price:2.9}], total:1450, status:'Completed', labelStatus:'Accepted', rewards:{organic:800,fairTrade:600}, docChecklist:[{name:'GMP', state:'Expiring Soon'}, {name:'HACCP', state:'Valid'}], docs:[], thread:[ {author:'C_IMP:Finance / Wallet Admin', msg:'Payment completed - thank you!', ts:now()}, {author:'C_PRO:Account Manager', msg:'Pleasure doing business', ts:now()} ], shipments:[{id:'S1', qty:500, ts:now(), received:true, receivedAt:now(), completed:true, completedAt:now()}], trace:{ lots:[ {id:'L-MASSAMAN-001', qty:300, source:'Specialty Spice Farms'}, {id:'L-MASSAMAN-002', qty:125, source:'Premium Herb Gardens'}, {id:'L-MASSAMAN-003', qty:75, source:'Artisan Producers'} ], chain:['Specialty Spice Farms','Premium Herb Gardens','Artisan Producers','C_PRO','C_IMP'], geo:'13.76,100.50' }, createdAt: now(), labelHistory: [ {id:'LBL_REQ006', action:'requested', actor:'C_IMP:QA / Label Manager', timestamp:now(), version:1, requirements:'Massaman curry paste premium labeling'}, {id:'LBL_UPL006', action:'uploaded', actor:'C_PRO:Quality Manager', timestamp:now(), version:2, fileName:'Massaman_Label_Premium.pdf', fileHash:'mass123', fileSize:2456789}, {id:'LBL_ACC006', action:'accepted', actor:'C_IMP:QA / Label Manager', timestamp:now(), version:3, comments:'Excellent premium labeling'} ] },
      { id:'P1007', buyerId:'C_IMP', supplierId:'C_PRO', currency:'EUR', items:[{name:'Fish Sauce 12x700ml', qty:400, price:4.2}], total:1680, status:'Completed', labelStatus:'Accepted', rewards:{organic:600,fairTrade:500}, docChecklist:[{name:'GMP', state:'Expiring Soon'}], docs:[], thread:[ {author:'C_IMP:Procurement Manager', msg:'Excellent quality as always', ts:now()}, {author:'C_PRO:Quality Manager', msg:'Traditional fermentation process maintained', ts:now()} ], shipments:[{id:'S1', qty:400, ts:now(), received:true, receivedAt:now(), completed:true, completedAt:now()}], trace:{ lots:[ {id:'L-FISH-001', qty:240, source:'Coastal Fisheries'}, {id:'L-FISH-002', qty:100, source:'Island Producers'}, {id:'L-FISH-003', qty:60, source:'Artisan Fishers'} ], chain:['Coastal Fisheries','Island Producers','Artisan Fishers','C_PRO','C_IMP'], geo:'12.55,101.02' }, createdAt: now(), labelHistory: [ {id:'LBL_REQ007', action:'requested', actor:'C_IMP:QA / Label Manager', timestamp:now(), version:1, requirements:'Traditional fish sauce labeling'}, {id:'LBL_UPL007', action:'uploaded', actor:'C_PRO:Quality Manager', timestamp:now(), version:2, fileName:'Fish_Sauce_Traditional.pdf', fileHash:'fish789', fileSize:1876543}, {id:'LBL_ACC007', action:'accepted', actor:'C_IMP:QA / Label Manager', timestamp:now(), version:3, comments:'Perfect traditional labeling'} ] },
      { id:'P2005', buyerId:'C_PRO', supplierId:'C_COO1', currency:'THB', items:[{name:'Fresh Galangal (kg)', qty:200, price:95}], total:19000, status:'Open', labelStatus:'Not Required', rewards:{organic:700,fairTrade:500}, docChecklist:[{name:'Organic', state:'Valid'}], docs:[], thread:[{author:'C_PRO:Account Manager', msg:'Need galangal for new product line', ts:now()}], shipments:[], trace:{ lots:[{id:'LOT-A',qty:600},{id:'LOT-B',qty:600}], chain:['C_COO1','C_PRO','C_IMP'], geo:'16.07,102.67 → 13.75,100.50 → 52.37,4.90' }, createdAt: now() },
      { id:'P1008', buyerId:'C_IMP', supplierId:'C_PRO', currency:'EUR', items:[{name:'Red Curry Paste 16x400g', qty:700, price:3.0}], total:2100, status:'Approved', labelStatus:'Accepted', rewards:{organic:1000,fairTrade:800}, docChecklist:[{name:'GMP', state:'Expiring Soon'}, {name:'HACCP', state:'Valid'}], docs:[], thread:[{author:'C_IMP:Procurement Manager', msg:'Red curry approved for production', ts:now()}], shipments:[], trace:{ lots:[{id:'LOT-A',qty:600},{id:'LOT-B',qty:600}], chain:['C_COO1','C_PRO','C_IMP'], geo:'16.07,102.67 → 13.75,100.50 → 52.37,4.90' }, createdAt: now(), labelHistory: [ {id:'LBL_REQ008', action:'requested', actor:'C_IMP:QA / Label Manager', timestamp:now(), version:1, requirements:'Red curry paste with heat level warnings'}, {id:'LBL_UPL008', action:'uploaded', actor:'C_PRO:Quality Manager', timestamp:now(), version:2, fileName:'Red_Curry_Label_v3.pdf', fileHash:'red456', fileSize:1654321}, {id:'LBL_ACC008', action:'accepted', actor:'C_IMP:QA / Label Manager', timestamp:now(), version:3, comments:'Great heat level indicators'} ] }
    ]
  };

  
let state = load() || seed;

// ---------- VeriPura Demo Augmentation V2 ----------
function augmentDemoV2(){
  if(state._augV2) return;
  const ensureCompany = (id, name, type, city)=>{
    if(!state.companies.find(c=>c.id===id)){
      state.companies.push({id, name, type, city});
    }
  };
  const ensurePartner = (aId,bId,status='Accepted',directionForA='Supplier',source='invitation')=>{
    const a = Math.min(aId, bId);
    const b = Math.max(aId, bId);
    if(!state.partners.find(p=>(p.aId===a && p.bId===b))){
      state.partners.push({id:'E'+Math.random().toString(36).slice(2,8), aId:a, bId:b, status, directionForA, source, createdAt: now()});
    }
  };
  const ensurePO = (po)=>{
    if(!state.pos.find(p=>p.id===po.id)){
      if(!po.total && po.items && po.items.length){
        po.total = po.items.reduce((s,it)=> s + Number(it.qty||0)*Number(it.price||0), 0);
      }
      po.docs = po.docs || [];
      po.thread = po.thread || [];
      po.shipments = po.shipments || [];
      po.labelStatus = po.labelStatus || 'Requested';
      po.createdAt = po.createdAt || now();
      state.pos.push(po);
    }
  };
  ensureCompany('C_PRO2','Siam Coconut Milk Ltd.','Processor','Surat Thani');
  ensureCompany('C_PRO3','Phuket Organic Coconut Cream Co.','Processor','Phuket');
  ensureCompany('C_PRO4','NoodleCup Foods Co., Ltd.','Processor','Ayutthaya');
  ensureCompany('C_PRO5','OceanBlue Tuna Canners','Processor','Samut Sakhon');
  ensureCompany('C_PRO6','Royal Bangkok Processing','Processor','Bangkok');
  ensureCompany('C_PRO7','Thai Heritage Foods','Processor','Phuket');
  ensureCompany('C_IMP2','EU Gourmet Imports','Importer','Rotterdam');
  ensureCompany('C_IMP_US','US Pacific Importers','Importer','Los Angeles');
  ensureCompany('C_IMP_CN','Shanghai Food Imports','Importer','Shanghai');
  ensureCompany('C_SUP1','Isaan Organic Cooperative','Coop','Udon Thani');
  ensureCompany('C_SUP2','Mekong Garlic Farmers Union','Coop','Chiang Rai');
  ensureCompany('C_SUP4','Chiang Mai Lemongrass Collective','Coop','Chiang Mai');
  
  ['C_PRO2','C_PRO3','C_PRO4','C_PRO5','C_PRO6','C_PRO7'].forEach(pid=> ensurePartner('C_IMP', pid, 'Accepted','Supplier','invitation'));
  ['C_IMP2','C_IMP_US','C_IMP_CN'].forEach(iid=> ensurePartner('C_PRO', iid, 'Accepted','Customer','invitation'));
  ['C_SUP1','C_SUP2','C_SUP4'].forEach(sid=> ensurePartner('C_PRO', sid, 'Accepted','Supplier','invitation'));
  const importerPOs = [
    {id:'P1101', buyerId:'C_IMP', supplierId:'C_PRO', currency:'EUR', items:[{name:'Sweet Chili Sauce 24x200ml', qty:800, price:1.2}], status:'Open', thread:[{author:'C_IMP:Procurement Manager', msg:'Kickoff — confirm delivery window', ts:now()}]},
    {id:'P1102', buyerId:'C_IMP', supplierId:'C_PRO', currency:'EUR', items:[{name:'Green Curry Paste 24x200g', qty:600, price:1.5}], status:'Open', thread:[{author:'C_PRO:Export Manager', msg:'Pricing ack; label pending', ts:now()}]},
    {id:'P1103', buyerId:'C_IMP', supplierId:'C_PRO', currency:'EUR', items:[{name:'Panang Curry Paste 12x300g', qty:500, price:1.9}], status:'Approved', labelStatus:'Accepted', thread:[{author:'C_IMP:Compliance Manager', msg:'Label accepted', ts:now()}]},
    {id:'P1104', buyerId:'C_IMP', supplierId:'C_PRO', currency:'EUR', items:[{name:'Sriracha 12x500ml', qty:700, price:1.8}], status:'Approved', labelStatus:'Accepted', thread:[{author:'C_PRO:Export Manager', msg:'Preparing shipment', ts:now()}]},
    {id:'P1105', buyerId:'C_IMP', supplierId:'C_PRO', currency:'EUR', items:[{name:'Tom Yum Paste 24x200g', qty:900, price:1.4}], status:'ReadyToShip', labelStatus:'Accepted', shipments:[{id:'S1', qty:300, ts:now()}], thread:[{author:'C_PRO:Logistics Manager', msg:'First partial shipment created', ts:now()}]},
    {id:'P1106', buyerId:'C_IMP', supplierId:'C_PRO', currency:'EUR', items:[{name:'Sweet Basil Leaves (jar)', qty:450, price:2.1}], status:'Shipped', labelStatus:'Accepted', shipments:[{id:'S1', qty:450, ts:now()}], thread:[{author:'C_PRO:Logistics Manager', msg:'Shipped today via Maersk', ts:now()}]},
    {id:'P1107', buyerId:'C_IMP', supplierId:'C_PRO', currency:'EUR', items:[{name:'Coconut Milk 24x400ml', qty:1200, price:0.95}], status:'Open', labelStatus:'Requested', thread:[{author:'C_IMP:QA / Label Manager', msg:'Please upload coconut label v1', ts:now()}]},
    {id:'P1108', buyerId:'C_IMP', supplierId:'C_PRO', currency:'EUR', items:[{name:'Chili Oil 12x250ml', qty:400, price:2.2}], status:'Open', labelStatus:'Requested', thread:[{author:'C_PRO:Export Manager', msg:'Will share label draft', ts:now()}]},
    {id:'P1109', buyerId:'C_IMP', supplierId:'C_PRO', currency:'EUR', items:[{name:'Pad Thai Sauce 12x500ml', qty:500, price:2.0}], status:'Approved', labelStatus:'Accepted', thread:[{author:'C_IMP:Procurement Manager', msg:'Approved — proceed to ship', ts:now()}]},
    {id:'P1110', buyerId:'C_IMP', supplierId:'C_PRO', currency:'EUR', items:[{name:'Yellow Curry Paste 20x250g', qty:650, price:1.6}], status:'ReadyToShip', labelStatus:'Accepted', shipments:[{id:'S1', qty:200, ts:now()}], thread:[{author:'C_PRO:Production Manager', msg:'Batch staged', ts:now()}]},
    {id:'P1111', buyerId:'C_IMP', supplierId:'C_PRO', currency:'EUR', items:[{name:'Fish Sauce 24x300ml', qty:1000, price:0.8}], status:'Shipped', labelStatus:'Accepted', shipments:[{id:'S1', qty:1000, ts:now()}], thread:[{author:'C_PRO:Logistics Manager', msg:'Container sealed', ts:now()}]},
    {id:'P1112', buyerId:'C_IMP', supplierId:'C_PRO', currency:'EUR', items:[{name:'Tamarind Paste 12x500g', qty:300, price:2.5}], status:'Completed', labelStatus:'Accepted', shipments:[{id:'S1', qty:300, ts:now(), received:true, receivedAt:now(), completed:true, completedAt:now()}], thread:[{author:'C_IMP:Logistics Coordinator', msg:'Received in warehouse', ts:now()}]},
  ];
  importerPOs.forEach(ensurePO);

  const supplierItems = [
    ['Fresh Red Chili (kg)',120,70], ['Dried Chili (kg)',90,85], ['Garlic (kg)',200,40], ['Lemongrass (kg)',180,35], ['Kaffir Lime Leaves (kg)',160,120], ['Galangal (kg)',150,55],
  ];
  ['C_COO1','C_COO2'].forEach((sid, idx)=>{
    for(let n=1;n<=6;n++){
      const [name, qty, price] = supplierItems[(n-1)%supplierItems.length];
      const poId = (sid==='C_COO1' ? 'P210' : 'P220') + n;
      const th = [];
      if(n<=4){ th.push({author: sid+':Sales Manager', msg:'Quote ready / available qty confirmed', ts: now()}); }
      ensurePO({ id: poId, buyerId:'C_PRO', supplierId:sid, currency:'THB', items:[{name, qty, price}], status: (n%3===0?'Approved': (n%2===0?'Open':'ReadyToShip')), labelStatus: (n%2===0?'Requested':'Not Required'), rewards:{organic:600,fairTrade:400}, docs:[], thread: th });
    }
  });

  state._augV2 = true;
  save();
}
augmentDemoV2();
// ---------- End Augmentation ----------


  // ---------- Relationship policy ----------
  function companyById(id){ return state.companies.find(c=>c.id===id); }
  function userById(id){ return (state.users || []).find(u=>u.id===id); }
  function typeOf(id){ const c = companyById(id); return c?c.type:null; }
  
  function allowedCounterpartiesFor(companyId){
    const t = typeOf(companyId);
    const others = state.companies.filter(c=>c.id!==companyId);
    if(t==='Importer') return others.filter(c=>c.type==='Processor');
    if(t==='Processor') return others.filter(c=>c.type==='Importer' || c.type==='Coop');
    if(t==='Coop') return others.filter(c=>c.type==='Processor');
    return [];
  }
  function isAllowedPair(aId, bId){
    const at = typeOf(aId), bt = typeOf(bId);
    if(at==='Importer' && bt==='Processor') return true;
    if(at==='Processor' && (bt==='Importer' || bt==='Coop')) return true;
    if(at==='Coop' && bt==='Processor') return true;
    return false;
  }

  function getAvailableLogisticsProviders(companyId, shipmentType = 'all') {
    const myType = typeOf(companyId);
    if (myType === 'Importer') {
      return state.logisticsProviders || [];
    } else if (myType === 'Processor') {
      return (state.logisticsProviders || []).filter(p => p.region === 'Thailand');
    } else if (myType === 'Coop') {
      return (state.logisticsProviders || []).filter(p => p.region === 'Thailand');
    }
    return [];
  }
  function renderLogisticsProviderDropdown(companyId, selectId = 'logisticsProvider') {
    const providers = getAvailableLogisticsProviders(companyId);
    const options = providers.map(p => 
      `<option value="${p.id}">${escapeHTML(p.name)} - ${escapeHTML(p.specialty)} (${escapeHTML(p.city)})</option>`
    ).join('');
    return `<select id="${selectId}" class="input">${options}</select>`;
  }

  // ---------- Current user session ----------
  let session = { companyId:null, role:null, userId:null };
  const app = document.getElementById('app');

  function getCurrentUser(){
    if(!session.userId) return null;
    return userById(session.userId);
  }
  
  function getAdminLevel(){
    const u = getCurrentUser();
    return u ? u.adminLevel : 'None';
  }
  
  function isAtLeast(level){
    const myLevel = getAdminLevel();
    const levels = { 'None':0, 'Limited':1, 'Standard':2, 'Super':3 };
    return (levels[myLevel] || 0) >= (levels[level] || 0);
  }

  function addAuditLog(action, details={}){
    const user = getCurrentUser();
    state.auditLog.push({
      ts: now(),
      actor: user ? `${user.name} (${user.role})` : 'System',
      actorId: user ? user.id : null,
      company: session.companyId,
      action: action,
      ...details
    });
  }

  function renderLogin(){
    app.innerHTML = `
      <div style="max-width:980px;margin:6vh auto;padding:1rem">
        <div class="grid cols-2">
          <div class="card" style="grid-column:1 / span 1">
            <div class="brand" style="font-size:1.35rem">VeriPura <small>EU-ASEAN Traceability Demo</small></div>
            <div class="divider"></div>
            <div class="col">
              <label class="label">Company</label>
              <select id="loginCompany"></select>
              <label class="label">User</label>
              <select id="loginUser"></select>
              <label class="label">Password <span class="muted small">(use "123" for all accounts)</span></label>
              <input id="loginPwd" class="input" type="password" placeholder="Enter: 123" />
              <div class="row">
                <button id="loginBtn" class="btn btn-brand">Sign in</button>
                <button id="seedReset" class="btn">Reset Data</button>
              </div>
              <div class="row" style="gap:.5rem;margin-top:.5rem;align-items:center;flex-wrap:wrap;">
                <label class="label small" for="vpThemeSelect" style="margin:0 .25rem 0 0;">Theme</label>
                <select id="vpThemeSelect" class="input" style="max-width:160px;">
                  <option value="dark">Dark</option>
                  <option value="light">Light</option>
                  <option value="light-warm">Warm Light</option>
                  <option value="emerald">Emerald</option>
                </select>
                <label class="label small" for="vpDensitySelect" style="margin:0 .25rem 0 .75rem;">Density</label>
                <select id="vpDensitySelect" class="input" style="max-width:140px;">
                  <option value="comfort">Comfort</option>
                  <option value="compact">Compact</option>
                </select>
              </div>
            </div>
          </div>
          
          <div class="card" id="loginPromo" style="grid-column:2 / span 1"><div class="section-title">Import trust in seconds</div><ul class="promo-list">
              <li><strong>$40B</strong> lost annually to food fraud; <strong>600M</strong> people fall ill and <strong>420K</strong> die from unsafe food.</li>
              <li><strong>30+ documents</strong> per EU shipment — errors cause costly delays and rework.</li>
              <li><strong>VeriPura</strong> automates document checks with AI and locks the chain of custody on blockchain.</li>
              <li><strong>Traceback in ~2 seconds</strong> with on-chain records (vs. 7 days with paper trails).</li>
            </ul><p class="promo-cta">Replace paper friction with digital trust.</p></div>

        </div>
          </div>
</div>

      </div>
    `;
    const companySel = $('#loginCompany');
    state.companies.forEach(c=>{
      const o = document.createElement('option'); o.value=c.id; o.textContent = `${c.name} — ${c.type}`; companySel.appendChild(o);
  try{ renderThemeControls(); }catch(e){}
  try{ window.__wireLoginAppearance && window.__wireLoginAppearance(); }catch(e){}
  try{ window.__wireLoginPromo && window.__wireLoginPromo(); }catch(e){}
});
    function populateUsers(){
      const companyId = companySel.value;
      const users = (state.users || []).filter(u=>u.companyId === companyId);
      const userSel = $('#loginUser'); userSel.innerHTML='';
      users.forEach(u=>{ const o=document.createElement('option'); o.value=u.id; o.textContent=`${u.name} (${u.role})`; userSel.appendChild(o); });
    }
    companySel.addEventListener('change', populateUsers);
    populateUsers();

    $('#loginBtn').addEventListener('click', ()=>{
      const userId = $('#loginUser').value;
      const password = $('#loginPwd').value;
      const user = userById(userId);

      if(!user){
        toast('User not found.','err'); return;
      }
      if(password !== '123'){
        toast('Invalid password. Use "123" for all accounts.', 'err');
        state.securityEvents.push({ts:now(), type:'failed_login', reason:'wrong_password', userId:user.id, email:user.email});
        save();
        return;
      }
      if(user.status === 'Suspended'){
        toast('This account is suspended. Please contact an administrator.', 'err');
        state.securityEvents.push({ts:now(), type:'failed_login', reason:'suspended', userId:user.id, email:user.email});
        save();
        return;
      }
      
      session.companyId = user.companyId;
      session.role = user.role;
      session.userId = user.id;
      user.lastLogin = now();
      saveSession();
      save(); 
      renderApp();
    });
    $('#seedReset').addEventListener('click', ()=>{
      localStorage.removeItem('vp'); 
      state = deepClone(seed);
      save(); 
      toast('Demo data reset.');
      location.reload();
    });
  }
  
  function ensureSessionCompany(){
    const me = companyById(session.companyId);
    if(!me || !getCurrentUser()){
      console.warn('Invalid session; resetting');
      session = {companyId:null, role:null, userId:null};
      saveSession();
      renderLogin();
      return null;
    }
    return me;
  }

  function saveSession(){ localStorage.setItem('vp_session', JSON.stringify(session)); }
  function loadSession(){ try{ const s=JSON.parse(localStorage.getItem('vp_session')); if(s&&s.companyId&&s.role&&s.userId){session=s;} }catch(e){} }

  
  const MAX_FILE_SIZE = 5 * 1024 * 1024;
  let isProcessing = false;

  async function processPDFForPO(file, po){
    if(!file) return toast('Select a PDF first.','warn');
    if(file.size > MAX_FILE_SIZE){ return toast('File too large (max 5MB)','err'); }
    if(isProcessing){ return toast('Please wait for current operation to complete','warn'); }
    isProcessing = true;
    try{
      const reader = new FileReader();
      return await new Promise((resolve,reject)=>{
        reader.onerror = ()=>{ reject(new Error('File read failed')); };
        reader.onload = async (e)=>{
          try{
            const dataUrl = e.target.result;
            const hash = await hashDataURL(dataUrl);
            po.docs = po.docs || [];
            po.docs.push({name:file.name, dataUrl, hash});
            po.thread.push({author: session.companyId+':'+session.role, msg:`Attached PDF ${escapeHTML(file.name)} [hash ${hash}]`, ts: now()});
            resolve(true);
          }catch(err){ reject(err); }
        };
        reader.readAsDataURL(file);
      });
    }catch(err){
      console.error('File processing error', err);
      toast('File processing failed','err');
      return false;
    } finally {
      isProcessing = false;
    }
  }

  function updateState(updateFn){
    try{ updateFn(); save(); return true; }
    catch(err){ console.error('State update failed:', err); toast('Operation failed','err'); return false; }
  }

  function renderApp(){
    const me = companyById(session.companyId);
    if(!me) return renderLogin();
    const currentUser = getCurrentUser();
    if (!currentUser) return renderLogin();
    const showAdminTab = session.role === 'Sys Admin';

    app.innerHTML = `
      <div class="layout">
        <aside class="sidebar">
          <div class="brand">VeriPura <small>${escapeHTML(me.name)}</small></div>
          <div class="divider"></div>
          <div class="col" style="gap:.5rem">
            <span class="chip">User: ${escapeHTML(currentUser.name)}</span>
            <span class="chip">Role: ${escapeHTML(session.role)}</span>
            <span class="chip" id="walletChip">VERI: ${getBalance(me.id)}</span>
          </div>
          <div class="divider"></div>
          <div class="nav" id="nav">
            <button data-tab="dashboard" class="active">Dashboard</button>
            <button data-tab="pos">Purchase Orders</button>
            <button data-tab="documents">Documents</button>
            <button data-tab="wallet">Wallet</button>
            <button data-tab="partners" class="${(session.role==='Logistics Manager'||session.role==='Logistics Coordinator')?'hidden':''}">Business Partners</button>
            <button data-tab="invitations" class="${canSeeInvitations()? '' : 'hidden'}">Invitations</button>
            <button data-tab="sysadmin" class="${showAdminTab ? '' : 'hidden'}">Sys Admin</button>
            <button id="logout" class="btn" style="margin-top:.5rem">Log out</button>
          </div>
        </aside>
        <main>
          <section id="tab-dashboard"></section>
          <section id="tab-pos" class="hidden"></section>
          <section id="tab-documents" class="hidden"></section>
          <section id="tab-wallet" class="hidden"></section>
          <section id="tab-partners" class="hidden"></section>
          <section id="tab-invitations" class="hidden"></section>
          <section id="tab-sysadmin" class="hidden"></section>
        </main>
      </div>
      <div id="modal" class="hidden"></div>
    `;
    $('#logout').addEventListener('click', ()=>{ localStorage.removeItem('vp_session'); session={companyId:null,role:null,userId:null}; renderLogin(); });
    $$('#nav button[data-tab]').forEach(btn=>{
      btn.addEventListener('click', (e)=>{
        $$('#nav button').forEach(b=>b.classList.remove('active'));
        e.currentTarget.classList.add('active');
        const tab = e.currentTarget.dataset.tab;
        ['dashboard','pos','documents','wallet','partners','invitations','sysadmin'].forEach(t=>{
          const el = document.getElementById('tab-'+t);
          if(el) el.classList.toggle('hidden', t!==tab);
        });
        if(tab==='dashboard') renderDashboard();
        if(tab==='pos') renderPOs();
        if(tab==='documents') renderDocuments();
        if(tab==='wallet') renderWallet();
        if(tab==='partners') renderPartners();
        if(tab==='invitations') renderInvitations();
        if(tab==='sysadmin') renderSysAdmin();
      });
    });
    renderDashboard();
    if(window._vpEnforceNavVisibility){ window._vpEnforceNavVisibility(); }
  }

  function renderDashboard(){
    const me = companyById(session.companyId);
    const myPOs = state.pos.filter(p=>p.buyerId===me.id || p.supplierId===me.id);
    const open = myPOs.filter(p=>p.status==='Open').length;
    const rts = myPOs.filter(p=>p.status==='ReadyToShip').length;
    const shipped = myPOs.filter(p=>p.status==='Shipped').length;
    const received = myPOs.filter(p=>p.status==='Received').length;
    const completed = myPOs.filter(p=>p.status==='Completed').length;
    const _me_guard = ensureSessionCompany(); if(!_me_guard) return; $('#tab-dashboard').innerHTML = `
      <div class="grid cols-3">
        <div class="card metric"><div class="h">Open POs</div><div class="v">${open}</div></div>
        <div class="card metric"><div class="h">Ready to Ship</div><div class="v">${rts}</div></div>
        <div class="card metric"><div class="h">Shipped / Received / Completed</div>
          <div class="v">${shipped} / ${received} / ${completed}</div>
        </div>
      </div>
      <div class="grid cols-2" style="margin-top:1rem">
        <div class="card">
          <div class="row-between"><div class="section-title">Recent Activity</div></div>
          <div id="dash-activity" class="small muted">Actions you take (PO approvals, shipments, wallet ops) will appear here.</div>
        </div>
        <div class="card">
          <div class="section-title">Your Company</div>
          <div class="row" style="flex-wrap:wrap">
            <span class="chip">Type: ${escapeHTML(me.type)}</span>
            <span class="chip">City: ${escapeHTML(me.city||'-')}</span>
            <span class="chip">Balance: <strong id="dashBalance">${getBalance(me.id)}</strong> VERI</span>
          </div>
          <div class="divider"></div>
          <div class="small muted">Invitations visible to operational roles only; Business Partners excludes yourself. Wallet transfers mirror PO relationship policy.</div>
        </div>
      </div>
    `;
  }

  function directionFor(viewerId, otherId){
    const vt = typeOf(viewerId), ot = typeOf(otherId);
    if(vt==='Importer' && ot==='Processor') return 'Supplier';
    if(vt==='Processor' && ot==='Importer') return 'Customer';
    if(vt==='Processor' && ot==='Coop') return 'Supplier';
    if(vt==='Coop' && ot==='Processor') return 'Customer';
    return '—';
    }
  function partnerStatus(aId, bId){
    const edge = state.partners.find(e => (e.aId===aId && e.bId===bId) || (e.aId===bId && e.bId===aId));
    return edge? edge.status : 'Prospect';
  }
  function canInviteFromRole(){
    const meType = typeOf(session.companyId);
    const r = session.role;
    if(meType==='Importer') return r==='Procurement Manager';
    if(meType==='Processor') return r==='Export Manager' || r==='Account Manager';
    if(meType==='Coop') return r==='Sales Manager';
    return false;
  }
  function canSeeInvitations(){
    const r = session.role;
    if(r === 'Logistics Manager' || r === 'Logistics Coordinator') return false;
    return canInviteFromRole();
  }
  
  function wirePartnerDelegatedHandlers(){
    const container = document.getElementById('tab-partners');
    if(!container || container.dataset.wired==='1') return;
    container.dataset.wired='1';
    container.addEventListener('click',(ev)=>{
      const btn = ev.target.closest('button');
      if(!btn) return;
      if(btn.classList.contains('btn-invite')){
        const targetId = btn.dataset.id;
        if(!isAllowedPair(session.companyId,targetId)){ toast('Not a permitted relationship.','err'); return; }
        if(!canInviteFromRole()){ toast('Your role cannot send invitations.','err'); return; }
        const inv = {id:'I'+Math.random().toString(36).slice(2,8), fromCompanyId:session.companyId, toCompanyId:targetId, fromType:typeOf(session.companyId), toType:typeOf(targetId), status:'Pending', createdAt: now()};
        state.invitations.push(inv); save(); toast('Invitation sent.');
        renderPartners();
      }
    });
  }

  function renderPartners(){
    wirePartnerDelegatedHandlers();
    const me = companyById(session.companyId);
    const others = state.companies.filter(c=>c.id!==me.id);
    const rows = others.map(o=>{
      const dir = directionFor(me.id, o.id);
      const stat = partnerStatus(me.id, o.id);
      const canInvite = canInviteFromRole() && isAllowedPair(me.id, o.id);
      const inviteBtn = canInvite ? `<button class="btn btn-primary btn-invite" data-id="${o.id}">Invite</button>` : `<span class="muted small">${isAllowedPair(me.id,o.id)?'No action':'Not permitted'}</span>`;
      return `<tr>
        <td>${escapeHTML(o.name)}</td>
        <td>${escapeHTML(o.type)}</td>
        <td><span class="tag">${dir}</span></td>
        <td><span class="tag ${stat==='Accepted'?'ok':stat==='Prospect'?'':'warn'}">${stat}</span></td>
        <td>${inviteBtn}</td>
      </tr>`;
    }).join('');
    $('#tab-partners').innerHTML = `
      <div class="row-between">
        <div class="section-title">Business Partners</div>
        <label class="small"><input type="checkbox" id="onlyAccepted" /> Show "My Partners" (Accepted)</label>
      </div>
      <div class="card">
        <table class="table" id="partnersTable">
          <thead><tr><th>Company</th><th>Type</th><th>Direction</th><th>Status</th><th>Actions</th></tr></thead>
          <tbody>${rows}</tbody>
        </table>
      </div>
    `;
    $('#onlyAccepted').addEventListener('change', (e)=>{
      const only = e.target.checked;
      const me = companyById(session.companyId);
      $$('#partnersTable tbody tr').forEach(tr=>{
        const name = tr.children[0].textContent;
        const other = state.companies.find(c=>c.name===name);
        const stat = partnerStatus(me.id, other.id);
        tr.style.display = (!only || stat==='Accepted') ? '' : 'none';
      });
    });
    $$('#partnersTable .btn-invite').forEach(btn=>{
      btn.addEventListener('click',()=>{
        const targetId = btn.dataset.id;
        if(!isAllowedPair(session.companyId, targetId)){ toast('Not a permitted relationship.','err'); return; }
        if(!canInviteFromRole()){ toast('Your role cannot send invitations.','err'); return; }
        const inv = {id: 'I'+Math.random().toString(36).slice(2,8), fromCompanyId:session.companyId, fromRole:session.role, toCompanyId:targetId, toType:typeOf(targetId), status:'Pending', createdAt:now()};
        state.invitations.push(inv); save(); toast('Invitation sent.'); renderPartners();
      });
    });
  }
  
  function wireInvitationDelegatedHandlers(){
    const container = document.getElementById('tab-invitations');
    if(!container || container.dataset.wired==='1') return;
    container.dataset.wired='1';
    container.addEventListener('click',(ev)=>{
      const btn = ev.target.closest('button');
      if(!btn) return;
      const id = btn.dataset.id;
      if(btn.id==='sendInvite'){
        const toId = ($('#invTarget')||{}).value;
        if(!toId) return toast('Choose a target company.','warn');
        if(!isAllowedPair(session.companyId,toId)){ return toast('Not a permitted relationship.','err'); }
        if(!canInviteFromRole()){ return toast('Your role cannot send invitations.','err'); }
        const inv = {id:'I'+Math.random().toString(36).slice(2,8), fromCompanyId:session.companyId, toCompanyId:toId, fromType:typeOf(session.companyId), toType:typeOf(toId), status:'Pending', createdAt:now()};
        state.invitations.push(inv); save(); toast('Invitation sent.'); renderInvitations(); renderPartners();
        return;
      }
      if(btn.classList.contains('btn-accept')){
        const inv = state.invitations.find(i=>i.id===id); if(!inv) return;
        inv.status='Accepted'; inv.decidedAt=now();
        const existing = state.partners.find(e=>(e.aId===inv.fromCompanyId && e.bId===inv.toCompanyId) || (e.aId===inv.toCompanyId && e.bId===inv.fromCompanyId));
        if(existing){ existing.status='Accepted'; } else { state.partners.push({id:'E'+Math.random().toString(36).slice(2,8), aId:Math.min(inv.fromCompanyId, inv.toCompanyId), bId:Math.max(inv.fromCompanyId, inv.toCompanyId), status:'Accepted', source:'invitation', createdAt: now()}); }
        save(); toast('Invitation accepted.'); renderInvitations(); renderPartners();
        return;
      }
      if(btn.classList.contains('btn-decline')){
        const inv = state.invitations.find(i=>i.id===id); if(!inv) return;
        inv.status='Declined'; inv.decidedAt=now(); save(); toast('Invitation declined.'); renderInvitations();
      }
    });
  }

  function renderInvitations(){
    wireInvitationDelegatedHandlers();
    if(!canSeeInvitations()){
      $('#tab-invitations').innerHTML = `<div class="card">Invitations are not available for your role.</div>`; return;
    }
    const me = companyById(session.companyId);
    const allowedTargets = allowedCounterpartiesFor(me.id);
    const options = allowedTargets.map(c=>`<option value="${c.id}">${escapeHTML(c.name)} — ${c.type}</option>`).join('');
    const sent = state.invitations.filter(i=>i.fromCompanyId===me.id);
    const received = state.invitations.filter(i=>i.toCompanyId===me.id);
    function inviteRow(i,isSent){
      const from = companyById(i.fromCompanyId), to = companyById(i.toCompanyId);
      const statusTag = `<span class="tag ${i.status==='Accepted'?'ok':i.status==='Pending'?'warn':'block'}">${i.status}</span>`;
      const actions = isSent
        ? (i.status==='Pending'? `<button class="btn btn-warn btn-cancel" data-id="${i.id}">Cancel</button>` : '—')
        : (i.status==='Pending'? `<button class="btn btn-brand btn-accept" data-id="${i.id}">Accept</button> <button class="btn btn-danger btn-decline" data-id="${i.id}">Decline</button>` : '—');
      return `<tr><td>${escapeHTML(from.name)} (${escapeHTML(i.fromRole)})</td><td>→</td><td>${escapeHTML(to.name)} (${escapeHTML(i.toType)})</td><td>${statusTag}</td><td>${actions}</td></tr>`;
    }
    $('#tab-invitations').innerHTML = `
      <div class="section-title">Invitations</div>
      <div class="card">
        <div class="row" style="flex-wrap:wrap;gap:.5rem 1rem">
          <div class="col"><label class="label">To Company</label><select id="invTarget">${options}</select></div>
          <div class="col"><label class="label">Target Type</label><input class="input" id="invType" class="input" value="${escapeHTML((allowedTargets && allowedTargets.length ? allowedTargets[0].type : ''))}" readonly /></div>
          <div class="col"><label class="label">From Role</label><input class="input" value="${escapeHTML(session.role)}" readonly /></div>
          <div class="col" style="align-self:end"><button id="sendInvite" class="btn btn-primary">Send Invitation</button></div>
        </div>
      </div>
      <div class="grid cols-2" style="margin-top:1rem">
        <div class="card">
          <div class="section-title">Received</div>
          <table class="table" id="invReceived"><tbody>${
            received.map(i=>inviteRow(i,false)).join('')||'<tr><td class="muted">— None —</td></tr>'
          }</tbody></table>
        </div>
        <div class="card">
          <div class="section-title">Sent</div>
          <table class="table" id="invSent"><tbody>${
            sent.map(i=>inviteRow(i,true)).join('')||'<tr><td class="muted">— None —</td></tr>'
          }</tbody></table>
        </div>
      </div>
    `;
    $('#invTarget').addEventListener('change', (e)=>{
      const t = companyById(e.target.value); $('#invType').value = t ? t.type : '';
    });
    $('#sendInvite').addEventListener('click', ()=>{
      const toId = $('#invTarget').value;
      if(!isAllowedPair(session.companyId, toId)){ toast('Not a permitted relationship.','err'); return; }
      if(!canInviteFromRole()){ toast('Your role cannot send invitations.','err'); }
      const inv = {id:'I'+Math.random().toString(36).slice(2,8), fromCompanyId:session.companyId, fromRole:session.role, toCompanyId:toId, toType:typeOf(toId), status:'Pending', createdAt:now()};
      state.invitations.push(inv); save(); toast('Invitation sent.'); renderInvitations();
    });
    $$('#invReceived .btn-accept').forEach(b=>b.addEventListener('click',()=>{
      const id = b.dataset.id; const inv = state.invitations.find(i=>i.id===id); if(!inv) return;
      inv.status='Accepted'; inv.decidedAt=now();
      const existing = state.partners.find(e=>(e.aId===inv.fromCompanyId && e.bId===inv.toCompanyId) || (e.aId===inv.toCompanyId && e.bId===inv.fromCompanyId));
      if(existing){ existing.status='Accepted'; }
      else{
        state.partners.push({id:'E'+Math.random().toString(36).slice(2,8), aId:inv.fromCompanyId, bId:inv.toCompanyId, status:'Accepted', directionForA: directionFor(inv.fromCompanyId, inv.toCompanyId), source:'invitation', createdAt: now()});
      }
      save(); toast('Invitation accepted.'); renderInvitations(); renderPartners();
    }));
    $$('#invReceived .btn-decline').forEach(b=>b.addEventListener('click',()=>{
      const id=b.dataset.id; const inv = state.invitations.find(i=>i.id===id); if(!inv) return;
      inv.status='Declined'; inv.decidedAt=now(); save(); toast('Invitation declined.','warn'); renderInvitations();
    }));
    $$('#invSent .btn-cancel').forEach(b=>b.addEventListener('click',()=>{
      const id=b.dataset.id; const inv=state.invitations.find(i=>i.id===id); if(!inv) return;
      if(inv.status!=='Pending'){ toast('Only pending invites can be cancelled.','warn'); return; }
      inv.status='Cancelled'; inv.decidedAt=now(); save(); toast('Invitation cancelled.'); renderInvitations();
    }));
  }

  function walletFor(companyId){
    let w = state.wallets.find(w=>w.companyId===companyId);
    if(!w){ w={companyId, balance:0, ledger:[]}; state.wallets.push(w); }
    return w;
  }
  function getBalance(companyId){ return walletFor(companyId).balance.toFixed(2); }
  function updateWalletChip(){
    $('#walletChip').textContent = 'VERI: ' + getBalance(session.companyId);
    const db = $('#dashBalance'); if(db) db.textContent = getBalance(session.companyId);
  }
  function canWalletAdmin(){ return session.role==='Finance / Wallet Admin'; }
  function renderWallet(){
    const me = companyById(session.companyId);
    const w = walletFor(me.id);
    const allowed = allowedCounterpartiesFor(me.id);
    const cpOpts = allowed.map(c=>`<option value="${c.id}">${escapeHTML(c.name)} — ${c.type}</option>`).join('');
    const readOnly = !canWalletAdmin();
    $('#tab-wallet').innerHTML = `
      <div class="row-between">
        <div class="section-title">Wallet</div>
        <div class="chip">Balance: <strong>${getBalance(me.id)}</strong> VERI</div>
      </div>
      <div class="grid cols-3">
        <div class="card">
          <div class="section-title">Buy VERI</div>
          <div class="col">
            <label class="label">Amount (fiat → VERI 1:1)</label>
            <input id="buyAmt" class="input" type="number" step="0.01" min="0" ${readOnly?'disabled':''} />
            <button id="buyBtn" class="btn btn-brand" ${readOnly?'disabled':''}>Buy</button>
          </div>
        </div>
        <div class="card">
          <div class="section-title">Send VERI</div>
          <div class="col">
            <label class="label">Counterparty</label>
            <select id="sendTo" ${readOnly?'disabled':''}>${cpOpts}</select>
            <label class="label">Amount</label>
            <input id="sendAmt" class="input" type="number" step="0.01" min="0" ${readOnly?'disabled':''} />
            <label class="label">PO (optional)</label>
            <input id="sendPO" class="input" placeholder="PO ID" ${readOnly?'disabled':''} />
            <button id="sendBtn" class="btn btn-primary" ${readOnly?'disabled':''}>Send</button>
          </div>
        </div>
        <div class="card">
          <div class="section-title">Purchase Services / Discounts</div>
          <div class="col">
            <select id="svcItem" ${readOnly?'disabled':''}>
              <option value="QA bundle|250">QA bundle — 250</option>
              <option value="Compliance verification|180">Compliance verification — 180</option>
              <option value="Label review|120">Label review — 120</option>
              <option value="5% discount|100">5% discount — 100</option>
            </select>
            <label class="label">PO (optional)</label>
            <input id="svcPO" class="input" placeholder="PO ID" ${readOnly?'disabled':''} />
            <button id="svcBuy" class="btn" ${readOnly?'disabled':''}>Purchase</button>
          </div>
        </div>
      </div>
      <div class="card" style="margin-top:1rem">
        <div class="section-title">Ledger</div>
        <table class="table">
          <thead><tr><th>When</th><th>Type</th><th>Detail</th><th>Amount</th></tr></thead>
          <tbody id="ledgerBody">
            ${w.ledger.slice().reverse().map(l=>`<tr><td class="small muted">${l.ts}</td><td>${l.kind}</td><td>${escapeHTML(l.detail||'')}</td><td class="${l.amount>=0?'oktext':'danger'}">${l.amount>=0?'+':''}${l.amount.toFixed(2)}</td></tr>`).join('') || '<tr><td class="muted">— No entries —</td></tr>'}
          </tbody>
        </table>
      </div>
      <div class="small muted ${readOnly?'':'hidden'}" style="margin-top:.5rem">Read-only: only Finance/Wallet Admins can buy/send/purchase.</div>
    `;
    if(canWalletAdmin()){
      $('#buyBtn').addEventListener('click', ()=>{
        const amt = parseFloat($('#buyAmt').value||'0'); if(!(amt>0)) return toast('Enter a positive amount.','warn');
        w.balance += amt; w.ledger.push({ts:now(), kind:'Received', detail:'VERI purchase (fiat)', amount:+amt});
        state.walletAuditLog.push({ts:now(), actor:session.role, company:session.companyId, action:'buy', amount:amt});
        save(); updateWalletChip(); renderWallet(); toast('Top-up complete.');
      });
      $('#sendBtn').addEventListener('click', ()=>{
        const toId = $('#sendTo').value;
        if(!isAllowedPair(me.id, toId)) return toast('Not a permitted relationship.','err');
        const amt = parseFloat($('#sendAmt').value||'0'); if(!(amt>0)) return toast('Enter a positive amount.','warn');
        if(w.balance < amt) return toast('Insufficient balance.','err');
        const po = $('#sendPO').value.trim();
        w.balance -= amt;
        w.ledger.push({ts:now(), kind:'Spent', detail:`Transfer to ${companyById(toId).name}${po?` (PO ${escapeHTML(po)})`:''}`, amount:-amt});
        const rw = walletFor(toId);
        rw.balance += amt;
        rw.ledger.push({ts:now(), kind:'Earned', detail:`Transfer from ${me.name}${po?` (PO ${escapeHTML(po)})`:''}`, amount:+amt});
        state.walletAuditLog.push({ts:now(), actor:session.role, company:session.companyId, action:'send', to:toId, amount:amt, po});
        save(); updateWalletChip(); renderWallet(); toast('Transfer sent.');
      });
      $('#svcBuy').addEventListener('click', ()=>{
        const val = $('#svcItem').value; const [item, priceStr] = val.split('|'); const price = parseFloat(priceStr||'0');
        if(walletFor(me.id).balance < price) return toast('Insufficient balance.','err');
        const po = $('#svcPO').value.trim();
        w.balance -= price;
        w.ledger.push({ts:now(), kind:'Spent', detail:`Service purchase — ${item}${po?` (PO ${escapeHTML(po)})`:''}`, amount:-price});
        state.walletAuditLog.push({ts:now(), actor:session.role, company:session.companyId, action:'purchase', item, price, po});
        save(); updateWalletChip(); renderWallet(); toast('Service purchased.');
      });
    }
  }

  
  function validatePOData(items, currency){
    if(!items || !items.length) throw new Error('At least one item required');
    items.forEach((it, idx)=>{
      if(!it.name || !it.name.trim()) throw new Error(`Item ${idx+1}: name required`);
      if(Number(it.qty) <= 0) throw new Error(`Item ${idx+1}: quantity must be positive`);
      if(Number(it.price) < 0) throw new Error(`Item ${idx+1}: price cannot be negative`);
    });
    return true;
  }

  function visiblePOsFor(companyId){
    return state.pos.filter(p=>p.buyerId===companyId || p.supplierId===companyId);
  }
  function roleCanSendPO(){
    const t = typeOf(session.companyId);
    if(t==='Importer' && session.role==='Procurement Manager') return true;
    if(t==='Processor' && (session.role==='Export Manager' || session.role==='Account Manager')) return true;
    return false;
  }
  function roleCanApprove(po){
    const meType = typeOf(session.companyId);
    if(po.buyerId===session.companyId){
      if(meType==='Importer' && session.role==='Procurement Manager') return true;
      if(meType==='Processor' && session.role==='Account Manager') return true;
    }
    return false;
  }
  function roleCanRequestQA(){
    const t = typeOf(session.companyId);
    return (t==='Importer' && session.role==='QA / Label Manager') || (t==='Processor' && session.role==='Quality Manager');
  }
  function roleCanRecordQA(){
    const t = typeOf(session.companyId);
    return (t==='Processor' && session.role==='Quality Manager') || (t==='Coop' && session.role==='QA Liaison');
  }
  function roleCanAddShipment(po){
    const meType = typeOf(session.companyId);
    if(po.supplierId===session.companyId){
      if(meType==='Processor' && (session.role==='Logistics Manager' || session.role==='Production Manager')) return true;
      if(meType==='Coop' && (session.role==='Sales Manager' || session.role==='Operations Manager')) return true;
    }
    if(po.buyerId===session.companyId){
      if(meType==='Importer' && session.role==='Logistics Coordinator') return true;
      if(meType==='Processor' && session.role==='Logistics Manager') return true;
    }
    return false;
  }
  
  function shouldShowLogisticsCoordination(po) {
    if(session.role === 'Logistics Manager' || session.role === 'Logistics Coordinator') {
      return po.buyerId === session.companyId || po.supplierId === session.companyId;
    }
    return roleCanAddShipment(po);
  }

  function wirePOCardActions(){
    const container = document.getElementById('tab-pos');
    if (!container) return;

    if (container.dataset.wired === '1') return;
    container.dataset.wired = '1';

    container.addEventListener('click', (ev) => {
      const btn = ev.target.closest('button');
      if(!btn) return;
      
      const id = btn.dataset.id;
      if(!id) return;

      const po = state.pos.find(p=>p.id===id);
      if(!po) return;

      const cl = btn.classList;
      if(cl.contains('btn-post')){
        const inp = document.getElementById('msg-'+id);
        const msg = (inp && inp.value || '').trim();
        if(!msg) return;
        po.thread.push({author: session.companyId+':'+session.role, msg: escapeHTML(msg), ts: now()});
        if(inp) inp.value='';
        save(); renderPOs();
        return;
      }
      if(cl.contains('btn-label-accept')){
        po.labelStatus='Accepted'; save(); toast('Label accepted.');
        renderPOs();
        return;
      }
      if(cl.contains('btn-approve')){
        if(!roleCanApprove(po)) return;
        po.status='Approved'; save(); toast('PO approved.');
        renderPOs();
        return;
      }
      if(cl.contains('btn-ship')){
        if(po.labelStatus!=='Accepted') return toast('Blocking: Label not accepted. Use Override + note to proceed.','err');
        const qty = po.items.reduce((a,it)=>a+Number(it.qty||0),0);
        const logisticsProvider = $(`#logistics-${id}`)?.value;
        const carrier = $(`#carrier-${id}`)?.value || 'TBD';
        const tracking = $(`#tracking-${id}`)?.value || '';
        const provider = state.logisticsProviders?.find(p => p.id === logisticsProvider);
        const providerName = provider ? provider.name : 'Not specified';
        const shipment = {
          id: 'S'+(po.shipments.length+1), 
          qty, 
          ts: now(),
          logisticsProvider: logisticsProvider,
          logisticsProviderName: providerName,
          carrier: carrier,
          tracking: tracking
        };
        po.shipments = po.shipments || []; 
        po.shipments.push(shipment);
        if(po.status==='Open' || po.status==='Approved') po.status='ReadyToShip';
        const logisticsMsg = `Shipment created: ${qty} units via ${escapeHTML(providerName)} (${escapeHTML(carrier)})${tracking ? `, Tracking: ${escapeHTML(tracking)}` : ''}`;
        po.thread.push({author: session.companyId+':'+session.role, msg: logisticsMsg, ts: now()});
        save(); 
        toast('Shipment with logistics coordination added.'); 
        renderPOs();
        return;
      }
      if(cl.contains('btn-override')){
        const note = prompt('Override requires a note. Explain why you proceed without Label: Accepted.');
        if(!note || !note.trim()) return toast('Override cancelled (note required).','warn');
        if(roleCanAddShipment(po)){
          const qty = po.items.reduce((a,it)=>a+Number(it.qty||0),0);
          po.shipments = po.shipments||[]; po.shipments.push({id:'S'+(po.shipments.length+1), qty, ts:now()});
          if(po.status==='Open' || po.status==='Approved') po.status='ReadyToShip';
          addAuditLog('po_override', { poId: po.id, alertCode:'LABEL_NOT_ACCEPTED', overrideNote: escapeHTML(note)});
          po.thread.push({author: session.companyId+':'+session.role, msg:`Shipment added without label (note: ${escapeHTML(note)})`, ts: now()});
        }else if(roleCanApprove(po)){
          const before = po.status;
          po.status='Approved';
          addAuditLog('po_override', { poId: po.id, alertCode:'LABEL_NOT_ACCEPTED', overrideNote: escapeHTML(note)});
          po.thread.push({author: session.companyId+':'+session.role, msg:`Approved without label (note: ${escapeHTML(note)})`, ts: now()});
        }
        save(); toast('Override recorded.');
        renderPOs();
        return;
      }
      if(cl.contains('btn-attach')){
        const input = document.getElementById('file-'+id);
        const file = input && input.files && input.files[0];
        if(!file) return toast('Select a PDF first.','warn');
        processPDFForPO(file, po).then(() => renderPOs());
      }
    });
  }


  function renderPOs(){
    const me = companyById(session.companyId);
    const myPOs = visiblePOsFor(me.id);
    const canSend = roleCanSendPO();
    const posReceived = myPOs.filter(p => p.supplierId === me.id);
    const posIssued = myPOs.filter(p => p.buyerId === me.id);
    $('#tab-pos').innerHTML = `
      <div class="row-between">
        <div class="section-title">Purchase Orders</div>
        <button id="btnNewPO" class="btn btn-brand ${canSend?'':'hidden'}">Send New PO</button>
      </div>
      <div class="grid cols-1" style="gap:1.5rem;">
        ${posReceived.length > 0 ? `
          <div>
            <div class="row-between" style="margin-bottom:.75rem;">
              <h3 style="color:var(--text);margin:0;">POs Received (${posReceived.length})</h3>
              <span class="muted small">Orders from customers to us</span>
            </div>
            <div class="col" id="posReceivedList">
              ${posReceived.map(poCard).join('')}
            </div>
          </div>
        ` : ''}
        ${posIssued.length > 0 ? `
          <div>
            <div class="row-between" style="margin-bottom:.75rem;">
              <h3 style="color:var(--text);margin:0;">POs Issued (${posIssued.length})</h3>
              <span class="muted small">Orders from us to suppliers</span>
            </div>
            <div class="col" id="posIssuedList">
              ${posIssued.map(poCard).join('')}
            </div>
          </div>
        ` : ''}
        ${posReceived.length === 0 && posIssued.length === 0 ? `
          <div class="card muted">No POs yet.</div>
        ` : ''}
      </div>
    `;
    $$('#posReceivedList .accordion-head, #posIssuedList .accordion-head').forEach(h=>h.addEventListener('click',()=>{
      const body = h.nextElementSibling; 
      body.style.display = body.style.display==='block' ? 'none' : 'block';
    }));
    wirePOCardActions();
    if(canSend){
      $('#btnNewPO').addEventListener('click', openNewPOModal);
    }
  }

  function poCard(p){
    
  ensureTrace(p);
const buyer = companyById(p.buyerId), supplier = companyById(p.supplierId);
    const alerts = [];
    if(p.labelStatus!=='Accepted') alerts.push('<span class="tag block">Label not accepted</span>');
    if(p.rewards && (p.rewards.organic || p.rewards.fairTrade || p.rewards.rainforest)) alerts.push('<span class="tag warn">Compliance awards pending</span>');
    const gmp = state.certs.find(c=>c.companyId===p.supplierId && c.type==='GMP');
    if(!gmp) alerts.push('<span class="tag warn">Processor GMP missing/expired</span>');
    else{
      const daysLeft = (new Date(gmp.expiresAt) - Date.now()) / 86400000;
      if(daysLeft<=0) alerts.push('<span class="tag warn">Processor GMP expired</span>');
      else if(daysLeft<30) alerts.push('<span class="tag warn">Processor GMP expiring soon</span>');
    }
    const traceVisible = ['ReadyToShip','Shipped','Received','Completed'].includes(p.status);
    const logisticsDropdown = roleCanAddShipment(p) ? renderLogisticsProviderDropdown(session.companyId, `logistics-${p.id}`) : '';
    return `
      <div class="accordion-item">
        <div class="accordion-head">
          <div class="row" style="gap:.75rem">
            <span class="pill">${escapeHTML(p.id)}</span>
            <strong>${escapeHTML(counterpartyName(p))}</strong>
            <span class="muted small">Status: ${escapeHTML(p.status)}</span>
            <span class="small">Label: <span class="tag ${p.labelStatus==='Accepted'?'ok':p.labelStatus==='Pending Review'?'warn':p.labelStatus==='Requested'?'warn':'block'}">${p.labelStatus}</span></span>
            <span class="small">Total: <strong>${p.total.toFixed(2)} ${escapeHTML(p.currency)}</strong></span>
            <span class="row" style="gap:.35rem">${alerts.join(' ')}</span>
          </div>
          <div>▼</div>
        </div>
        <div class="accordion-body">
          <div class="grid cols-2">
            <div class="col">
              <div class="section-title">Thread</div>
              <div class="card" id="thread-${p.id}">${p.thread.map(t=>`<div class="row" style="gap:.5rem"><span class="pill">${escapeHTML(t.author)}</span><span class="small">${escapeHTML(t.msg)}</span><span class="muted small right">${t.ts}</span></div>`).join('')}</div>
              <div class="inline-form" style="margin-top:.5rem">
                <input class="input" id="msg-${p.id}" placeholder="Add message..." />
                <button class="btn btn-primary btn-post" data-id="${p.id}">Post</button>
              </div>
              <div class="divider"></div>
              <div class="section-title">QA & Label</div>
              <div class="row" style="flex-wrap:wrap;gap:.5rem">
                <button class="btn btn-primary btn-req-qa ${roleCanRequestQA()?'':'hidden'}" data-id="${p.id}">Request Testing</button>
                <button class="btn btn-ok btn-label-accept ${roleCanRequestQA()?'':'hidden'}" data-id="${p.id}">Mark Label Accepted</button>
                <span class="muted small">QA Results can be recorded by Processor Quality Manager or Coop QA Liaison.</span>
              </div>
            </div>
            <div class="col">
                <div class="section-title">Actions</div>
                <div class="row" style="flex-wrap:wrap;gap:.5rem">
                  <button class="btn btn-brand btn-approve ${roleCanApprove(p)?'':'hidden'}" data-id="${p.id}">Approve</button>
                  <button class="btn btn-primary btn-ship ${roleCanAddShipment(p)?'':'hidden'}" data-id="${p.id}">Add Shipment</button>
                  <button class="btn btn-warn btn-override ${roleCanApprove(p)||roleCanAddShipment(p)?'':'hidden'}" data-id="${p.id}">Override (with note)</button>
                </div>
                ${shouldShowLogisticsCoordination(p) ? `
                  <div class="divider"></div>
                  <div class="section-title">🚛 Logistics Coordination</div>
                  <div class="card" style="background:#0a1016;border:1px solid #1a4b3a;">
                    <div class="col">
                      <label class="label">Logistics Provider</label>
                      ${logisticsDropdown}
                      <label class="label">Carrier/Transport Mode</label>
                      <input class="input" id="carrier-${p.id}" placeholder="e.g., Truck #TH-1234, Container MSKU-12345" />
                      <label class="label">Tracking Reference</label>
                      <input class="input" id="tracking-${p.id}" placeholder="Optional tracking number" />
                      <div class="small muted" style="margin-top:.5rem;">
                        ${getAvailableLogisticsProviders(session.companyId).length} providers available for ${typeOf(session.companyId)}
                      </div>
                    </div>
                  </div>` : ''}
              <div class="divider"></div>
              <div class="section-title">Documents</div>
              <div id="doclist-${p.id}" class="card small">${(p.attachedDocs || []).map(d=>`<div>${escapeHTML(d.name)} <span class="muted">[Attached at ${d.attachedAt}]</span></div>`).join('')||'<div class="muted">— No documents attached —</div>'}</div>
              <div class="inline-form" style="margin-top:.5rem">
                <input class="input" type="file" id="file-${p.id}" accept="application/pdf" />
                <button class="btn btn-primary btn-attach" data-id="${p.id}">Attach PDF</button>
              </div>
            </div>
          </div>
          <div class="divider"></div>
          <div class="section-title">Traceability & Shipments</div>
          <div id="trace-${p.id}" class="card small">${traceVisible ? renderTrace(p) : '<span class="muted">Traceability appears when status is ReadyToShip / Shipped / Received / Completed.</span>'}</div>
        </div>
      </div>
    `;
  }
  function renderTrace(p){
    
  ensureTrace(p);
let html = '';
    if(p.trace && Object.keys(p.trace).length > 0) {
      const t = p.trace;
      const lots = (t.lots||[]).map(l=>`<span class="pill">${escapeHTML(l.id)}: ${l.qty}</span>`).join(' ');
      const chain = (t.chain||[]).join(' → ');
      html += `<div class="col">
        <div><strong>Supply Chain:</strong> ${escapeHTML(chain||'—')}</div>
        <div><strong>Lot Traceability:</strong> ${lots||'—'}</div>
        <div><strong>Geographic Origin:</strong> ${escapeHTML(t.geo||'—')}</div>
      </div>`;
    }
    if(p.shipments && p.shipments.length > 0) {
      html += '<div class="divider"></div><div class="section-title small">Logistics & Shipments</div><div class="col">';
      p.shipments.forEach((s, idx) => {
        const logisticsInfo = s.logisticsProviderName ? `via <strong>${escapeHTML(s.logisticsProviderName)}</strong>` : '';
        const carrierInfo = s.carrier ? `Carrier: <span class="kbd">${escapeHTML(s.carrier)}</span>` : '';
        const trackingInfo = s.tracking ? `Tracking: <span class="kbd">${escapeHTML(s.tracking)}</span>` : '';
        
        const details = [carrierInfo, trackingInfo].filter(Boolean).join(' | ');
        
        html += `<div class="small">
          <strong>Shipment ${idx + 1}:</strong> ${s.qty} units ${logisticsInfo}
          ${details ? `<br><span class="muted">${details}</span>` : ''}
        </div>`;
      });
      html += '</div>';
    }
    return html || '<span class="muted">— No trace or shipment data —</span>';
  }

  function openNewPOModal(){
    const me = companyById(session.companyId);
    const targets = allowedCounterpartiesFor(me.id);
    const targetOpts = targets.map(c=>`<option value="${c.id}">${escapeHTML(c.name)} — ${c.type}</option>`).join('');
    const modal = $('#modal');
    modal.classList.remove('hidden');
    modal.innerHTML = `
      <div class="card" style="position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.45);z-index:999">
        <div class="card" style="max-width:860px;width:95%;max-height:88vh;overflow:auto;background:#0d1217">
          <div class="row-between">
            <div class="section-title">Send New PO</div>
            <button id="xModal" class="btn">Close</button>
          </div>
          <div class="grid cols-2">
            <div class="col">
              <label class="label">Supplier</label>
              <select id="poSupplier">${targetOpts}</select>
              <label class="label">Currency</label>
              <select id="poCur"><option>EUR</option><option>USD</option><option>THB</option></select>
              <div class="divider"></div>
              <div class="section-title">Items</div>
              <table class="table" id="poItems">
                <thead><tr><th>Item</th><th>Qty</th><th>Unit Price</th><th>Total</th><th></th></tr></thead>
                <tbody></tbody>
              </table>
              <button id="addRow" class="btn btn-primary">Add Row</button>
              <div class="row right"><div class="chip">Grand Total: <strong id="grandTotal">0.00</strong></div></div>
            </div>
            <div class="col">
              <label class="label">Attach PO PDF (optional)</label>
              <input id="poFile" class="input" type="file" accept="application/pdf" />
              <label class="label">Initial message</label>
              <input id="poMsg" class="input" placeholder="Kickoff note..." />
              <div class="divider"></div>
              <div class="section-title">Compliance rewards (VERI)</div>
              <div class="grid cols-3">
                <div><label class="label small">Organic</label><input id="rwOrg" class="input" type="number" step="1" value="1000" /></div>
                <div><label class="label small">Fair Trade</label><input id="rwFair" class="input" type="number" step="1" value="1000" /></div>
                <div><label class="label small">Rainforest</label><input id="rwRain" class="input" type="number" step="1" value="1000" /></div>
              </div>
              <div class="divider"></div>
              <div class="section-title">Doc requests</div>
              <div id="docBadges" class="row" style="flex-wrap:wrap;gap:.5rem"></div>
            </div>
          </div>
          <div class="divider"></div>
          <div class="row-between">
            <span class="muted small">Notes: inputs sanitized; file hashed for tamper detection.</span>
            <button id="createPO" class="btn btn-brand">Create PO</button>
          </div>
        </div>
      </div>
    `;
    $('#xModal').addEventListener('click', ()=>{ modal.classList.add('hidden'); modal.innerHTML=''; });
    const tbody = $('#poItems tbody');
    function addRow(item='', qty=0, price=0){
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input class="input it-name" value="${escapeHTML(item)}" /></td>
        <td><input class="input it-qty" type="number" step="0.01" value="${qty}"/></td>
        <td><input class="input it-price" type="number" step="0.01" value="${price}"/></td>
        <td class="it-total">0.00</td>
        <td><button class="btn btn-danger btn-del">×</button></td>
      `;
      tbody.appendChild(tr);
      recalc();
      tr.querySelectorAll('input').forEach(inp=>inp.addEventListener('input', recalc));
      tr.querySelector('.btn-del').addEventListener('click', ()=>{ tr.remove(); recalc(); });
    }
    function recalc(){
      let total = 0;
      $$('#poItems tbody tr').forEach(tr=>{
        const q = parseFloat(tr.querySelector('.it-qty').value||'0');
        const pr = parseFloat(tr.querySelector('.it-price').value||'0');
        const tt = (q*pr)||0;
        total += tt;
        tr.querySelector('.it-total').textContent = tt.toFixed(2);
      });
      $('#grandTotal').textContent = total.toFixed(2);
    }
    $('#addRow').addEventListener('click', ()=> addRow());
    addRow('',1,1);

    function renderDocBadges(){
      const supId = $('#poSupplier').value;
      const out = [];
      const needed = ['GMP','Organic','FairTrade'];
      needed.forEach(t=>{
        const c = state.certs.find(c=>c.companyId===supId && c.type===t);
        if(!c){ out.push(`<span class="tag warn">${t}: Missing</span>`); return; }
        const daysLeft = (new Date(c.expiresAt) - Date.now())/86400000;
        if(daysLeft<=0) out.push(`<span class="tag warn">${t}: Expired</span>`);
        else if(daysLeft<30) out.push(`<span class="tag warn">${t}: Expiring soon</span>`);
        else out.push(`<span class="tag ok">${t}: Valid</span>`);
      });
      $('#docBadges').innerHTML = out.join(' ');
    }
    $('#poSupplier').addEventListener('change', renderDocBadges);
    renderDocBadges();

    $('#createPO').addEventListener('click', async ()=>{
      const supplierId = $('#poSupplier').value;
      if(!supplierId){ toast('Select a supplier.', 'warn'); return; }
      const items = $$('#poItems tbody tr').map(tr=>{
        return {
          name: escapeHTML(tr.querySelector('.it-name').value||''),
          qty: parseFloat(tr.querySelector('.it-qty').value||'0'),
          price: parseFloat(tr.querySelector('.it-price').value||'0')
        };
      }).filter(it=>it.name && it.qty>0 && it.price>=0);
      if(items.length===0){ toast('Add at least one item.','warn'); return; }
      const currency = $('#poCur').value;
      const rewards = {organic: +$('#rwOrg').value||0, fairTrade:+$('#rwFair').value||0, rainforest:+$('#rwRain').value||0};
      const total = items.reduce((a,it)=>a+(it.qty*it.price),0);
      const id = shortId();
      const msg = $('#poMsg').value.trim();
      const po = {
        id, buyerId: session.companyId, supplierId, currency, items, total, status:'Open', labelStatus:'Requested',
        rewards, docChecklist:[], docs:[], thread:[], shipments:[], trace:{ lots:[{id:'LOT-A',qty:600},{id:'LOT-B',qty:600}], chain:['C_COO1','C_PRO','C_IMP'], geo:'16.07,102.67 → 13.75,100.50 → 52.37,4.90' }, createdAt: now()
      };
      if(msg) po.thread.push({author: session.companyId+':'+session.role, msg: escapeHTML(msg), ts: now()});
      save();
      const file = $('#poFile').files[0];
      if(file){
        const reader=new FileReader();
        reader.onload = async (e)=>{
          try{
            const dataUrl = e.target.result; const hash = await hashDataURL(dataUrl);
            po.docs.push({name:file.name, dataUrl, hash});
            finalize();
          } catch(err){ console.error('File read/hash error', err); toast('File processing failed','err'); }
        };
        reader.readAsDataURL(file);
      }else finalize();
      function finalize(){
        state.pos.push(po); save(); toast('PO created.'); $('#modal').classList.add('hidden'); $('#modal').innerHTML=''; renderPOs();
      }
    });
  }

  function wireSysAdminHandlers(){
    const container = document.getElementById('tab-sysadmin');
    if(!container) return;
    container.addEventListener('click', (ev) => {
        const target = ev.target;
        if(target.matches('.admin-tabs button')){
            $$('.admin-tabs button').forEach(b => b.classList.remove('active'));
            target.classList.add('active');
            $$('.admin-content').forEach(c => c.classList.remove('active'));
            const tabId = target.dataset.tab;
            $('#' + tabId).classList.add('active');
        }
        if(target.matches('#addUserBtn')){
          if(!isAtLeast('Standard')){ toast('Standard Admin permission required.', 'err'); return; }
          openUserModal();
        }
        if(target.matches('.btn-edit-user')){
          if(!isAtLeast('Standard')){ toast('Standard Admin permission required.', 'err'); return; }
          const userId = target.dataset.id;
          const targetUser = userById(userId);
          if(!targetUser || targetUser.companyId !== session.companyId) {
            toast('Cannot edit users from other companies.', 'err'); 
             return;
          }
          openUserModal(userId);
        }
        if(target.matches('.btn-toggle-status')){
          if(!isAtLeast('Limited')){ toast('Limited Admin permission required.', 'err'); return; }
          const userId = target.dataset.id;
          const user = userById(userId);
          if(!user || user.companyId !== session.companyId) {
            toast('Cannot modify users from other companies.', 'err'); 
             return;
          }
          const oldStatus = user.status;
          const newStatus = oldStatus === 'Active' ? 'Suspended' : 'Active';
          user.status = newStatus;
          addAuditLog('user_status_change', { targetUserId: user.id, targetUserEmail: user.email, from: oldStatus, to: newStatus });
          save();
          toast(`User ${newStatus.toLowerCase()}.`);
          renderSysAdminUsers(); 
         }
        if(target.matches('#exportAuditBtn')){
          const companyAuditLog = state.auditLog.concat(state.walletAuditLog).filter(log => log.company === session.companyId);
          exportToCSV(companyAuditLog, 'veripura_company_audit_log.csv');
        }
        if(target.matches('#exportSecurityBtn')){
          const companySecurityEvents = state.securityEvents.filter(log => {
            const user = userById(log.userId);
            return user && user.companyId === session.companyId;
          });
          exportToCSV(companySecurityEvents, 'veripura_company_security_log.csv');
        }
    });
    container.addEventListener('input', (ev) => {
      if(ev.target.matches('#userSearch, #userStatusFilter, #userRoleFilter')){
        renderSysAdminUsers();
      }
    });
  }

  function renderSysAdmin(){
    if(session.role !== 'Sys Admin'){
        $('#tab-sysadmin').innerHTML = `<div class="card">Access denied.</div>`;
        return;
    }
    wireSysAdminHandlers();
    
    const users = state.users || [];
    const companyUsers = users.filter(u => u.companyId === session.companyId);
    const metrics = {
        users: companyUsers.length,
        active: companyUsers.filter(u=>u.status==='Active').length,
        suspended: companyUsers.filter(u=>u.status==='Suspended').length,
        pos: state.pos.filter(p => p.buyerId === session.companyId || p.supplierId === session.companyId).length,
        partners: state.partners.filter(p => p.aId === session.companyId || p.bId === session.companyId).length
    };
    $('#tab-sysadmin').innerHTML = `
      <div class="admin-tabs">
          <button data-tab="admin-overview" class="active">Overview</button>
          <button data-tab="admin-users">User Management</button>
          <button data-tab="admin-security">Security Center</button>
          <button data-tab="admin-interface">Interface Management</button>
          <button data-tab="admin-audit">Audit & Compliance</button>
      </div>
      <div id="admin-overview" class="admin-content active">
          <div class="section-title">System Health Dashboard</div>
          <div class="grid cols-4">
              <div class="card metric"><div class="h">Company Users</div><div class="v">${metrics.users}</div></div>
              <div class="card metric"><div class="h">Active Users</div><div class="v oktext">${metrics.active}</div></div>
              <div class="card metric"><div class="h">Suspended</div><div class="v warntext">${metrics.suspended}</div></div>
              <div class="card metric"><div class="h">Company POs</div><div class="v">${metrics.pos}</div></div>
          </div>
          <div class="card" style="margin-top:1rem;">
              <div class="section-title">Recent Admin Actions</div>
              <table class="table small">
                <thead><tr><th>When</th><th>Actor</th><th>Action</th><th>Detail</th></tr></thead>
                <tbody>${state.auditLog.filter(a => a.company === session.companyId).slice().reverse().slice(0,5).map(a => `
                  <tr>
                    <td>${a.ts}</td>
                    <td>${escapeHTML(a.actor)}</td>
                    <td>${escapeHTML(a.action)}</td>
                    <td>${escapeHTML( (a.targetUserEmail || '') + (a.poId? 'PO '+a.poId:'') )}</td>
                  </tr>`).join('') || '<tr><td colspan="4" class="muted">No admin actions recorded.</td></tr>'}
                </tbody>
              </table>
          </div>
      </div>
      <div id="admin-users" class="admin-content">
      </div>
      <div id="admin-security" class="admin-content">
        <div class="section-title">Security Center</div>
        <div class="card">
          <p>Password policies, MFA management, and security event monitoring would be configured here in a production system.</p>
          <p class="muted small">This is a placeholder for the demo.</p>
        </div>
      </div>
      <div id="admin-interface" class="admin-content">
        <div class="section-title">Interface Management</div>
        <div class="card">
          <p>API keys, webhooks, and other system integration settings would be managed here.</p>
          <p class="muted small">This is a placeholder for the demo.</p>
        </div>
      </div>
      <div id="admin-audit" class="admin-content">
        <div class="grid cols-2">
          <div class="card">
            <div class="row-between">
              <div class="section-title">Company Audit Log</div>
              <button id="exportAuditBtn" class="btn">Export CSV</button>
            </div>
            <div style="max-height: 400px; overflow-y: auto;">
            <table class="table small">
              <thead><tr><th>When</th><th>Actor</th><th>Action</th><th>Detail</th></tr></thead>
              <tbody>${state.auditLog.concat(state.walletAuditLog).filter(log => log.company === session.companyId).sort((a,b)=>b.ts.localeCompare(a.ts)).map(log => `
                <tr>
                  <td>${escapeHTML(log.ts)}</td>
                  <td>${escapeHTML(log.actor || log.company)}</td>
                  <td>${escapeHTML(log.action)}</td>
                  <td>${escapeHTML(JSON.stringify(log.changes || log.detail || log.targetUserEmail || log.poId || ''))}</td>
                </tr>`).join('')}
              </tbody>
            </table>
            </div>
          </div>
          <div class="card">
            <div class="row-between">
              <div class="section-title">Security Events Log</div>
              <button id="exportSecurityBtn" class="btn">Export CSV</button>
            </div>
            <div style="max-height: 400px; overflow-y: auto;">
            <table class="table small">
              <thead><tr><th>When</th><th>Type</th><th>Reason</th><th>User</th></tr></thead>
              <tbody>${(state.securityEvents || []).filter(log => {
                const user = userById(log.userId);
                return user && user.companyId === session.companyId;
              }).sort((a,b)=>b.ts.localeCompare(a.ts)).map(log => `
                <tr>
                  <td>${escapeHTML(log.ts)}</td>
                  <td>${escapeHTML(log.type)}</td>
                  <td>${escapeHTML(log.reason)}</td>
                  <td>${escapeHTML(log.email)}</td>
                </tr>`).join('')}
              </tbody>
            </table>
            </div>
          </div>
        </div>
      </div>
    `;
    renderSysAdminUsers();
  }

  function renderSysAdminUsers() {
    const container = $('#admin-users');
    if(!container) return;
    const searchTerm = ($('#userSearch')?.value || '').toLowerCase();
    const statusFilter = $('#userStatusFilter')?.value || 'all';
    const roleFilter = $('#userRoleFilter')?.value || 'all';
    
    let filteredUsers = (state.users || []).filter(u => {
      const sameCompany = u.companyId === session.companyId;
      const matchesSearch = u.name.toLowerCase().includes(searchTerm) || u.email.toLowerCase().includes(searchTerm);
      const matchesStatus = statusFilter === 'all' || u.status === statusFilter;
      const matchesRole = roleFilter === 'all' || u.role === roleFilter;
      return sameCompany && matchesSearch && matchesStatus && matchesRole;
    });
    
    const companyUsers = (state.users || []).filter(u => u.companyId === session.companyId);
    const allRoles = [...new Set(companyUsers.map(u => u.role))];
    container.innerHTML = `
      <div class="row-between">
          <div class="section-title">User Management</div>
          <button id="addUserBtn" class="btn btn-brand">Add New User</button>
      </div>
      <div class="card">
          <div class="inline-form" style="padding-bottom:1rem; border-bottom:1px solid var(--border); margin-bottom:1rem;">
              <input id="userSearch" class="input" placeholder="Search by name or email..." />
              <select id="userStatusFilter" class="input">
                  <option value="all">All Statuses</option>
                  <option value="Active">Active</option>
                  <option value="Suspended">Suspended</option>
              </select>
              <select id="userRoleFilter" class="input">
                  <option value="all">All Roles</option>
                  ${allRoles.map(r => `<option value="${r}">${r}</option>`).join('')}
              </select>
          </div>
          <table class="table">
              <thead><tr><th>Name</th><th>Email</th><th>Role</th><th>Status</th><th>MFA</th><th>Admin Level</th><th>Actions</th></tr></thead>
              <tbody>${filteredUsers.map(u => `
                  <tr>
                      <td>${escapeHTML(u.name)}</td>
                      <td>${escapeHTML(u.email)}</td>
                      <td>${escapeHTML(u.role)}</td>
                      <td><span class="tag ${u.status==='Active' ? 'ok' : 'warn'}">${u.status}</span></td>
                      <td><span class="pill">${u.mfaEnabled ? 'On' : 'Off'}</span></td>
                      <td><span class="chip">${u.adminLevel}</span></td>
                      <td class="nowrap">
                          <button class="btn btn-primary small btn-edit-user" data-id="${u.id}">Edit</button>
                          <button class="btn ${u.status==='Active' ? 'btn-warn' : 'btn-ok'} small btn-toggle-status" data-id="${u.id}">
                              ${u.status==='Active' ? 'Suspend' : 'Activate'}
                          </button>
                      </td>
                  </tr>`).join('') || '<tr><td colspan="7" class="muted">No users match filters.</td></tr>'}
              </tbody>
          </table>
      </div>`;
  }

  function openUserModal(userId = null){
    const user = userId ? userById(userId) : null;
    const isEditing = !!user;
    const modal = $('#modal');
    modal.classList.remove('hidden');
    const companyOptions = `<option value="${session.companyId}" selected>${escapeHTML(companyById(session.companyId).name)}</option>`;

    const companyType = typeOf(session.companyId);
    const availableRoles = state.roles[companyType] || [];
    const roleOptions = availableRoles.map(r => `<option value="${r}" ${user?.role === r ? 'selected':''}>${escapeHTML(r)}</option>`).join('');
    const adminLevelOptions = ['None', 'Limited', 'Standard', 'Super'].map(lvl => `<option value="${lvl}" ${user?.adminLevel === lvl ? 'selected':''}>${lvl}</option>`).join('');
    modal.innerHTML = `
      <div class="card" style="position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.45);z-index:999;">
        <div class="card" style="width:500px;background:#0d1217">
          <div class="row-between">
            <div class="section-title">${isEditing ? 'Edit User' : 'Add New User'}</div>
            <button id="xModal" class="btn">×</button>
          </div>
          <div class="col">
            <label class="label">Full Name</label>
            <input id="userName" class="input" value="${escapeHTML(user?.name || '')}" />
            <label class="label">Email</label>
            <input id="userEmail" class="input" type="email" value="${escapeHTML(user?.email || '')}" ${isEditing ? 'readonly' : ''} />
            <label class="label">Company</label>
            <select id="userCompany" class="input" disabled>${companyOptions}</select>
            <label class="label">Role</label>
            <select id="userRole" class="input">${roleOptions}</select>
            <label class="label">Admin Level</label>
            <select id="userAdminLevel" class="input" ${!isAtLeast('Super') ? 'disabled':''}>${adminLevelOptions}</select>
            <div class="row">
              <input type="checkbox" id="userMfa" ${user?.mfaEnabled ? 'checked':''}>
              <label for="userMfa" class="label">MFA Enabled</label>
            </div>
            <div class="row right">
              <button id="saveUserBtn" class="btn btn-brand">${isEditing ? 'Save Changes' : 'Create User'}</button>
            </div>
          </div>
        </div>
      </div>
    `;
    $('#xModal').addEventListener('click', () => { modal.classList.add('hidden'); modal.innerHTML=''; });
    $('#saveUserBtn').addEventListener('click', () => {
        const name = $('#userName').value.trim();
        const email = $('#userEmail').value.trim();
        const companyId = session.companyId;
        const role = $('#userRole').value;
        const adminLevel = $('#userAdminLevel').value;
        const mfaEnabled = $('#userMfa').checked;
        if(!name || !email || !role){
            toast('All fields are required.', 'warn');
            return;
        }
        if(isEditing){
            const originalUser = deepClone(user);
            user.name = name;
            user.companyId = companyId;
            user.role = role;
            if(isAtLeast('Super')) user.adminLevel = adminLevel;
            user.mfaEnabled = mfaEnabled;
            addAuditLog('user_update', {
              targetUserId: user.id,
              targetUserEmail: user.email,
              changes: getObjectDiff(originalUser, user)
            });
            toast('User updated successfully.');
        } else {
            if((state.users || []).find(u => u.email.toLowerCase() === email.toLowerCase())){
              toast('User with this email already exists.', 'err');
              return;
            }
            const newUser = {
                id: shortId('U'),
                name, email, companyId, role, adminLevel: isAtLeast('Super') ? adminLevel : 'None', mfaEnabled,
                status: 'Active',
                createdAt: now(),
                lastLogin: null
            };
            state.users.push(newUser);
            addAuditLog('user_create', {targetUserId: newUser.id, targetUserEmail: newUser.email});
            toast('User created successfully.');
        }
        save();
        renderSysAdminUsers();
        modal.classList.add('hidden');
        modal.innerHTML='';
    });
  }

  function getObjectDiff(orig, updated) {
    const diff = [];
    for(const key in updated){
      if(orig.hasOwnProperty(key) && String(orig[key]) !== String(updated[key])){
        diff.push({ field: key, from: orig[key], to: updated[key]});
      }
    }
    return diff;
  }

  function exportToCSV(data, filename) {
    if (!data || data.length === 0) {
      toast('No data to export.', 'warn');
      return;
    }
    const replacer = (key, value) => value === null ? '' : value;
    const header = Object.keys(data[0]);
    const csv = [
      header.join(','),
      ...data.map(row => header.map(fieldName => JSON.stringify(row[fieldName], replacer)).join(','))
    ].join('\r\n');

    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    if (link.download !== undefined) {
      const url = URL.createObjectURL(blob);
      link.setAttribute("href", url);
      link.setAttribute("download", filename);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
  }
  
  function canManageDocuments(){
    const allowedRoles = ['QA / Label Manager', 'Logistics Coordinator', 'Sys Admin'];
    return allowedRoles.includes(session.role);
  }
  function canViewDocuments(){
    return true; 
  }
  function getDocumentStatus(doc){
    if (!doc.expiresAt) return 'Permanent';
    const daysLeft = (new Date(doc.expiresAt) - Date.now()) / 86400000;
    if (daysLeft <= 0) return 'Expired';
    if (daysLeft <= 30) return 'Expiring Soon';
    return 'Valid';
  }
  function getCompanyDocuments(companyId){
    return state.companyDocuments?.filter(doc => doc.companyId === companyId) || [];
  }
  
  function fileToDataURL(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
        reader.readAsDataURL(file);
    });
  }

  async function uploadCompanyDocument(file, metadata){
    if (!canManageDocuments()) {
      toast('Your role cannot upload documents.', 'err');
      return false;
    }
    if (file.size > MAX_FILE_SIZE) {
      toast('File too large (max 5MB)', 'err');
      return false;
    }
    try {
      const dataUrl = await fileToDataURL(file);
      const hash = await hashDataURL(dataUrl);
      const doc = {
        id: shortId('DOC'),
        companyId: session.companyId,
        name: metadata.name || file.name,
        category: metadata.category,
        type: metadata.type,
        description: metadata.description,
        fileHash: hash,
        dataUrl: dataUrl,
        uploadedBy: session.userId,
        uploadedAt: now(),
        expiresAt: metadata.expiresAt,
        tags: metadata.tags || []
      };
      if (!state.companyDocuments) state.companyDocuments = [];
      state.companyDocuments.push(doc);
      addAuditLog('document_upload', {
        documentId: doc.id,
        documentName: doc.name,
        category: doc.category
      });
      save();
      return doc;
    } catch (err) {
      console.error(err);
      toast('Document upload failed', 'err');
      return false;
    }
  }

  function getCategoryDescription(category) {
    const descs = {
      'Regulatory': 'Official permits and licenses required for operation.',
      'Quality & Safety': 'Certifications related to food safety and quality standards.',
      'Sustainability': 'Documents for ethical and environmental claims.',
      'Operational': 'Logistics, insurance, and commercial paperwork.',
      'Product-Specific': 'Detailed analysis and specifications for products.'
    };
    return descs[category] || 'General documents.';
  }

  function renderDocuments(){
    const me = companyById(session.companyId);
    const documents = getCompanyDocuments(me.id);
    const canManage = canManageDocuments();
    
    const docsByCategory = {};
    if (state.documentCategories) {
        Object.keys(state.documentCategories).forEach(cat => {
            docsByCategory[cat] = documents.filter(doc => doc.category === cat);
        });
    }

    $('#tab-documents').innerHTML = `
      <div class="row-between">
        <div class="section-title">Company Documents</div>
        <button id="btnUploadDoc" class="btn btn-brand ${canManage ? '' : 'hidden'}">Upload Document</button>
      </div>
      <div class="grid cols-1" style="gap:1rem;">
        ${Object.entries(docsByCategory).map(([category, docs]) => `
          <div class="card">
            <div class="row-between">
              <h3 style="margin:0;">${escapeHTML(category)} (${docs.length})</h3>
              <span class="muted small">${getCategoryDescription(category)}</span>
            </div>
            <div class="divider"></div>
            ${docs.length > 0 ? renderDocumentTable(docs) : '<div class="muted">No documents in this category.</div>'}
          </div>
        `).join('')}
      </div>
    `;
    if (canManage) {
      $('#btnUploadDoc').addEventListener('click', openUploadModal);
    }
    wireDocumentActions();
  }

  function renderDocumentTable(docs){
    return `
      <table class="table">
        <thead>
          <tr>
            <th>Document</th><th>Type</th><th>Status</th><th>Expires</th><th>Uploaded</th><th>Actions</th>
          </tr>
        </thead>
        <tbody>
          ${docs.map(doc => {
            const status = getDocumentStatus(doc);
            const statusClass = status === 'Valid' ? 'ok' : status === 'Expired' ? 'block' : 'warn';
            return `
              <tr>
                <td>
                  <strong>${escapeHTML(doc.name)}</strong>
                  ${doc.description ? `<br><span class="muted small">${escapeHTML(doc.description)}</span>` : ''}
                </td>
                <td>${escapeHTML(doc.type || '-')}</td>
                <td><span class="tag ${statusClass}">${status}</span></td>
                <td class="small">${doc.expiresAt ? new Date(doc.expiresAt).toLocaleDateString() : 'Never'}</td>
                <td class="small">${new Date(doc.uploadedAt).toLocaleDateString()}</td>
                <td class="nowrap">
                  <button class="btn btn-primary small btn-view-doc" data-id="${doc.id}">View</button>
                  <button class="btn btn-primary small btn-attach-doc" data-id="${doc.id}">Attach to PO</button>
                  ${canManageDocuments() ? `<button class="btn btn-danger small btn-delete-doc" data-id="${doc.id}">Delete</button>` : ''}
                </td>
              </tr>
            `;
          }).join('')}
        </tbody>
      </table>
    `;
  }

  function openUploadModal(){
    const modal = $('#modal');
    modal.classList.remove('hidden');
    const categories = Object.keys(state.documentCategories || {});
    const categoryOptions = categories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
    modal.innerHTML = `
      <div class="card" style="position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.45);z-index:999">
        <div class="card" style="width:600px;background:#0d1217">
          <div class="row-between">
            <div class="section-title">Upload Company Document</div>
            <button id="xModal" class="btn">×</button>
          </div>
          <div class="col">
            <label class="label">Document File</label>
            <input id="docFile" class="input" type="file" accept=".pdf,.jpg,.jpeg,.png" />
            <label class="label">Document Name</label>
            <input id="docName" class="input" placeholder="Enter document name" />
            <label class="label">Category</label>
            <select id="docCategory" class="input">${categoryOptions}</select>
            <label class="label">Document Type</label>
            <select id="docType" class="input"></select>
            <label class="label">Description (Optional)</label>
            <textarea id="docDescription" class="input" placeholder="Additional notes about this document"></textarea>
            <label class="label">Expiration Date (Optional)</label>
            <input id="docExpires" class="input" type="date" />
            <div class="row right" style="margin-top:1rem;">
              <button id="uploadBtn" class="btn btn-brand">Upload Document</button>
            </div>
          </div>
        </div>
      </div>
    `;
    $('#docCategory').addEventListener('change', updateDocumentTypes);
    $('#xModal').addEventListener('click', () => { modal.classList.add('hidden'); modal.innerHTML=''; });
    $('#uploadBtn').addEventListener('click', handleDocumentUpload);
    updateDocumentTypes();
  }
  
  function updateDocumentTypes() {
    const category = $('#docCategory').value;
    const types = state.documentCategories[category] || [];
    const typeSelect = $('#docType');
    typeSelect.innerHTML = types.map(t => `<option value="${t}">${t}</option>`).join('');
  }

  async function handleDocumentUpload() {
    const fileInput = $('#docFile');
    const file = fileInput.files[0];
    if (!file) {
        toast('Please select a file to upload.', 'warn');
        return;
    }
    const metadata = {
        name: $('#docName').value.trim(),
        category: $('#docCategory').value,
        type: $('#docType').value,
        description: $('#docDescription').value.trim(),
        expiresAt: $('#docExpires').value || null
    };

    if (!metadata.name) {
        toast('Document Name is required.', 'warn');
        return;
    }
    
    const uploadedDoc = await uploadCompanyDocument(file, metadata);
    if (uploadedDoc) {
        toast('Document uploaded successfully.', 'ok');
        $('#modal').classList.add('hidden');
        $('#modal').innerHTML = '';
        renderDocuments();
    }
  }

  function wireDocumentActions() {
    const container = $('#tab-documents');
    if (!container) return;
    container.addEventListener('click', (ev) => {
        const btn = ev.target.closest('button');
        if (!btn) return;
        const docId = btn.dataset.id;
        if (!docId) return;

        if (btn.classList.contains('btn-view-doc')) {
            const doc = state.companyDocuments.find(d => d.id === docId);
            if (doc && doc.dataUrl) {
                window.open(doc.dataUrl, '_blank');
            } else {
                toast('Document content not available for viewing.', 'warn');
            }
        }
        
        if (btn.classList.contains('btn-delete-doc')) {
            if (confirm('Are you sure you want to delete this document?')) {
                const docIndex = state.companyDocuments.findIndex(d => d.id === docId);
                if (docIndex > -1) {
                    const doc = state.companyDocuments[docIndex];
                    addAuditLog('document_delete', { documentId: doc.id, documentName: doc.name });
                    state.companyDocuments.splice(docIndex, 1);
                    save();
                    toast('Document deleted.');
                    renderDocuments();
                }
            }
        }
        
        if (btn.classList.contains('btn-attach-doc')) {
            openAttachToPOModal(docId);
        }
    });
  }

  function openAttachToPOModal(docId) {
    const modal = $('#modal');
    modal.classList.remove('hidden');
    const myOpenPOs = state.pos.filter(p => (p.buyerId === session.companyId || p.supplierId === session.companyId) && p.status !== 'Completed');
    
    if (myOpenPOs.length === 0) {
      toast('You have no open POs to attach this document to.', 'warn');
      modal.classList.add('hidden');
      return;
    }

    const poOptions = myOpenPOs.map(po => `<option value="${po.id}">PO ${po.id} (${po.items[0].name})</option>`).join('');
    
    modal.innerHTML = `
      <div class="card" style="position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.45);z-index:999">
        <div class="card" style="width:500px;background:#0d1217">
          <div class="row-between">
            <div class="section-title">Attach Document to PO</div>
            <button id="xModal" class="btn">×</button>
          </div>
          <div class="col">
            <label class="label">Select a Purchase Order</label>
            <select id="poSelect" class="input">${poOptions}</select>
            <div class="row right" style="margin-top:1rem;">
              <button id="confirmAttachBtn" class="btn btn-brand">Attach</button>
            </div>
          </div>
        </div>
      </div>
    `;
    
    $('#xModal').addEventListener('click', () => { modal.classList.add('hidden'); modal.innerHTML=''; });
    $('#confirmAttachBtn').addEventListener('click', () => {
      const poId = $('#poSelect').value;
      attachDocumentToPO(docId, poId);
      if ($('#tab-pos') && !$('#tab-pos').classList.contains('hidden')) {
        renderPOs();
      }
      modal.classList.add('hidden');
      modal.innerHTML = '';
    });
  }
  
  function attachDocumentToPO(docId, poId){
    const doc = state.companyDocuments?.find(d => d.id === docId);
    const po = state.pos.find(p => p.id === poId);
    if (!doc || !po) return;

    if (!po.attachedDocs) po.attachedDocs = [];
    if (po.attachedDocs.some(d => d.docId === docId)) {
      toast(`Document is already attached to PO ${poId}`, 'warn');
      return;
    }
    
    po.attachedDocs.push({
      docId: doc.id,
      name: doc.name,
      attachedBy: session.userId,
      attachedAt: now()
    });

    po.thread.push({
      author: session.companyId + ':' + session.role,
      msg: `Attached company document: ${escapeHTML(doc.name)}`,
      ts: now()
    });
    save();
    toast(`Document attached to PO ${poId}`);
  }

  // Always start with login screen
  renderLogin();

})();
</script>

<script>
(function(){
  'use strict';

  // === Helpers to detect session + company type ===
  const TAB_IDS = ['dashboard','pos','documents','wallet','partners','invitations','sysadmin'];
  const THEME_KEY='vp_theme', DENSITY_KEY='vp_density';

  function getSession(){
    try{ 
       return window.session || JSON.parse(localStorage.getItem('vp_session')||'{}'); 
     } catch(e) { 
       console.warn('Session data unavailable:', e);
      return {}; 
     }
  }
  function getState(){ 
     const state = window.state || {};
     if (!state.companies) state.companies = [];
     if (!state.users) state.users = [];
     if (!state.pos) state.pos = [];
     if (!state.products) state.products = [];
    return state;
  }
  function companyById(id){ const s=getState(); return (s.companies||[]).find(c=>c.id===id) || {}; }
  function companyType(c){
    const type=(c?.type||'').toLowerCase();
    if(type) return type;
    const name=(c?.name||'').toLowerCase();
    if(/coop|co-op|farmer/.test(name)) return 'coop';
    if(/importer/.test(name)) return 'importer';
    return 'processor';
  }

  // === Your approved visibility rules (S2/F1/L1) ===
  // === CONSOLIDATED TAB RULES (source of truth: TAB_RULES from JSON) ===
const RULES = {
  importer: TAB_RULES.Importer || {},
  processor: TAB_RULES.Processor || {},
  coop: TAB_RULES.Coop || {}
};

  // === Apply tab visibility after renderApp builds the UI ===
  
function applyTabVisibility(){
  try{
    // Resolve context
    const ctx = (typeof _vpCurrentContext === 'function') ? _vpCurrentContext() : {companyType:null, role:null};
    // Pull rule from unified source of truth
    let rule = null;
    if (ctx.companyType && ctx.role) {
      // Prefer TAB_RULES (arrays of tab names)
      const map = (typeof TAB_RULES !== 'undefined') ? TAB_RULES[ctx.companyType] : null;
      if (map && map[ctx.role]) rule = map[ctx.role];
      // Fallback: legacy RULES shape ({show,hide})
      if (!rule && typeof RULES !== 'undefined') {
        const legacyMap = RULES[(ctx.companyType||'').toLowerCase()] || RULES[ctx.companyType];
        if (legacyMap) rule = legacyMap[ctx.role];
      }
    }

    // Normalize rule -> {allowed:Set, denied:Set}
    let allowed = new Set();
    let denied = new Set();

    if (Array.isArray(rule)) {
      allowed = new Set(rule);
    } else if (rule && typeof rule === 'object') {
      allowed = new Set(rule.show || []);
      denied = new Set(rule.hide || []);
    } else {
      // No rule? Strict deny.
      allowed = new Set();
    }

    // Determine tab ids from DOM if TAB_IDS not available
    let ids = (typeof TAB_IDS !== 'undefined' && Array.isArray(TAB_IDS)) ? TAB_IDS.slice() : [];
    if (ids.length === 0) {
      ids = Array.from(document.querySelectorAll('.nav button[data-tab]')).map(b=>b.getAttribute('data-tab'));
      if (ids.length === 0) {
        ids = Array.from(document.querySelectorAll('.nav button')).map(b => (b.textContent||'').trim());
      }
    }

    const nav = document.querySelector('.nav');
    if (!nav) return;

    ids.forEach(id => {
      const btn = nav.querySelector(`button[data-tab="${id}"]`) || Array.from(nav.querySelectorAll('button')).find(b => (b.textContent||'').trim() === id);
      if (!btn) return;

      // If we have explicit deny, obey it. Otherwise, if allowed set present, obey it.
      let shouldShow = true;
      if (denied.size > 0) {
        shouldShow = !denied.has(id);
      }
      if (allowed.size > 0) {
        shouldShow = allowed.has(id);
      }

      btn.style.display = shouldShow ? '' : 'none';
      btn.classList.toggle('hidden', !shouldShow);
    });

  }catch(e){
    console.warn('applyTabVisibility error:', e);
  }
}
)[role]; 
  // === KPI cards on Dashboard (role-aware by company type) ===
  function computeKPIs(){
    const {pos=[], users=[], products=[]} = getState();
    const now=new Date(), y=now.getFullYear();
    const ytdPOs = pos.filter(p=> (new Date(p.createdAt||now)).getFullYear()===y );
    const shipped = ytdPOs.filter(p=> /shipped|received|completed/i.test(p.status||''));
    const rejectedProducts = (products||[]).filter(x=> x.rejected===true || /rejected/i.test(x?.status||''));
    const totalProducts = (products||[]).length || 1;
    return {
      importer: {
        k1:{label:'YTD POs Issued', value:ytdPOs.length},
        k2:{label:'YTD POs Shipped', value:shipped.length},
        k3:{label:'YTD Products Rejected', value: Math.round((rejectedProducts.length/totalProducts)*100), unit: '%'}
      },
      processor: {
        k1:{label:'Supplier Doc On-Time', value: estimatePct('docOnTime', 92), unit: '%' },
        k2:{label:'First-Pass QA Pass', value: estimatePct('qaPass', 96), unit: '%' },
        k3:{label:'Ready-to-Ship Backlog', value: pos.filter(p=> /readytoship/i.test(p.status||'')).length }
      },
      coop: {
        k1:{label:'Docs On-Time', value: estimatePct('docOnTime', 94), unit: '%' },
        k2:{label:'QA Pass', value: estimatePct('qaPass', 98), unit: '%' },
        k3:{label:'VERI Earned (30d)', value: estimateSum('veri30d') }
      }
    };
    function estimatePct(kind, base){ return (base + Math.floor(Math.random()*6)); }
    function estimateSum(kind){ return  Math.floor(100+Math.random()*400); }
  }

  function injectDashboardKPIs(){
    const dash=document.getElementById('tab-dashboard'); 
    if(!dash) {
      console.warn('Dashboard tab not found');
      return;
    }
    const sess=getSession(); const comp=companyById(sess.companyId); const type=companyType(comp);
    const kpis=computeKPIs()[type] || {};
    let wrap=dash.querySelector('#kpiRow'); if(wrap) wrap.remove();
    wrap=document.createElement('div'); wrap.id='kpiRow';
    wrap.className='grid cols-3'; wrap.style.margin='0 0 .75rem 0';
    ['k1','k2','k3'].forEach(key=>{
      const k=kpis[key] || {label:'—',value:'—'};
      const card=document.createElement('div'); card.className='card metric';
      card.innerHTML = `
        <div class="h">${k.label}</div>
        <div class="v">${k.value}${k.unit||''}</div>
      `;
      wrap.appendChild(card);
    });
    dash.prepend(wrap);
  }

  // === Sys Admin sub-menus with content ===
  function buildSysAdmin(){
    const tab=document.getElementById('tab-sysadmin'); 
    if(!tab) {
      console.warn('SysAdmin tab not found');
      return;
    }
    tab.innerHTML = `
      <div class="admin-tabs">
          <button data-sub="security" class="active">Security Center</button>
          <button data-sub="interface">Interface Management</button>
          <button data-sub="audit">Audit & Compliance</button>
      </div>
      <div id="sysSub"></div>
    `;
    const sub = tab.querySelector('#sysSub');
    function render(which){
      tab.querySelectorAll('button[data-sub]').forEach(b=> b.classList.toggle('active', b.dataset.sub===which));
      if(which==='security') renderSecurity(sub);
      if(which==='interface') renderInterface(sub);
      if(which==='audit') renderAudit(sub);
    }
    tab.querySelectorAll('button[data-sub]').forEach(b=> b.onclick = ()=> render(b.dataset.sub));
    render('security');
  }
  
  function updateAuditTable(container, filteredLogs) {
    const tbody = container.querySelector('tbody');
    if (!tbody) return;
    tbody.innerHTML = filteredLogs.map(log => `
      <tr>
        <td>${escapeHTML(log.ts)}</td><td>${escapeHTML(log.actor)}</td>
        <td>${escapeHTML(log.action)}</td>
        <td>${escapeHTML(JSON.stringify(Object.fromEntries(Object.entries(log).filter(([k])=>!['ts','actor','action'].includes(k)))))}</td>
      </tr>`).join('');
  }
  function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
      const later = () => {
        clearTimeout(timeout);
        func(...args);
      };
      clearTimeout(timeout);
      timeout = setTimeout(later, wait);
    };
  }

  function renderSecurity(root){
    const s=getState(), users=s.users||[], invites=s.invitations||[];
    const failed = (s.securityEvents||[]).filter(e=>e.type==='failed_login').length;
    const suspended=(users.filter(u=>/suspended/i.test(u.status||'')).length);
    root.innerHTML = `
      <div class="grid cols-4">
        <div class="card metric"><div class="h">Active Users</div><div class="v">${users.length - suspended}</div></div>
        <div class="card metric"><div class="h">Suspended</div><div class="v">${suspended}</div></div>
        <div class="card metric"><div class="h">Failed Logins (24h)</div><div class="v">${failed}</div></div>
        <div class="card metric"><div class="h">Pending Invites</div><div class="v">${(invites.filter(i=>/sent|pending/i.test(i.status||'')).length)||0}</div></div>
      </div>
      <div class="card" style="margin-top:.5rem">
        <div class="section-title">Users & Roles</div>
        <div class="table small" id="tblUsers"></div>
      </div>
      <div class="card" style="margin-top:.5rem">
        <div class="section-title">Invitations</div>
        <div class="table small" id="tblInvites"></div>
      </div>
      <div class="card" style="margin-top:.5rem">
        <div class="section-title">Access Policies</div>
        <div class="row" style="gap:.5rem;

// === Injected sample: Recent Security Events ===
(function(){
  const host = document.querySelector('#content .panel') || root;
  const card = document.createElement('div'); card.className='card';
  const h = document.createElement('div'); h.className='section-title'; h.textContent='Recent Security Events';
  const tbl = document.createElement('table'); tbl.className='table';
  tbl.innerHTML = '<thead><tr><th>When</th><th>Type</th><th>Reason/IP</th><th>User</th></tr></thead><tbody></tbody>';
  card.appendChild(h); card.appendChild(tbl);
  host.appendChild(card);
  const rows = [
    {ts:'2025-09-09 09:02', type:'failed_login', reason:'Invalid password (203.0.113.15)', user:'C_IMP:User1'},
    {ts:'2025-09-09 11:17', type:'password_reset', reason:'Requested via email', user:'C_PRO:User2'}
  ];
  const tb = tbl.querySelector('tbody');
  rows.forEach(r=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${r.ts}</td><td>${r.type}</td><td>${r.reason}</td><td>${r.user}</td>`;
    tb.appendChild(tr);
  });
})();
flex-wrap:wrap">
          <label>Session timeout (mins) <input class="input" style="width:90px" value="60"></label>
          <label><input type="checkbox" checked> Require re-login on role change</label>
          <label><input type="checkbox"> 2FA required</label>
          <label>Allowed email domains <input class="input" placeholder="example.com, acme.org" style="min-width:260px"></label>
        </div>
      </div>
      <div class="card" style="margin-top:.5rem">
        <div class="section-title">Data Guardrails</div>
        <div class="row" style="gap:1rem;flex-wrap:wrap">
          <label><input type="checkbox" checked> Override requires note</label>
          <label><input type="checkbox" checked> Block approval until Label = Accepted</label>
          <label><input type="checkbox"> QA required for ReadyToShip</label>
        </div>
      </div>
    `;
    const tU=root.querySelector('#tblUsers');  
    tU.innerHTML = `<table><thead><tr><th>Name</th><th>Email</th><th>Company</th><th>Role</th><th>Status</th><th>Last Login</th></tr></thead>
      <tbody>${users.map(u=>`<tr><td>${u.name||''}</td><td>${u.email||''}</td><td>${(companyById(u.companyId).name||'')}</td><td>${u.role||''}</td><td>${u.status||''}</td><td>${u.lastLogin||'—'}</td></tr>`).join('')}</tbody></table>`;
    const tI=root.querySelector('#tblInvites');
    tI.innerHTML = `<table><thead><tr><th>To Company</th><th>Role</th><th>Sent</th><th>Status</th></tr></thead>
      <tbody>${(invites||[]).map(i=>`<tr><td>${companyById(i.toCompanyId).name||''}</td><td>${i.toType||''}</td><td>${i.createdAt||'—'}</td><td>${i.status||''}</td></tr>`).join('')}</tbody></table>`;
  }

  function renderInterface(root){
    const theme = (document.documentElement.getAttribute('data-theme') || localStorage.getItem(THEME_KEY) || 'dark');
    const density = (document.documentElement.getAttribute('data-density') || localStorage.getItem(DENSITY_KEY) || 'comfort');
    root.innerHTML = `
      <div class="grid cols-2">
        <div class="card">
          <div class="section-title">Branding</div>
          <div class="row" style="gap:.5rem;

// === Injected sample: Interface Activity ===
(function(){
  const host = document.querySelector('#content .panel') || root;
  const card = document.createElement('div'); card.className='card';
  const h = document.createElement('div'); h.className='section-title'; h.textContent='Interface Activity';
  const tbl = document.createElement('table'); tbl.className='table';
  tbl.innerHTML = '<thead><tr><th>When</th><th>Type</th><th>Detail</th></tr></thead><tbody></tbody>';
  card.appendChild(h); card.appendChild(tbl);
  host.appendChild(card);
  const rows = [
    {ts:'2025-09-09 10:00', type:'webhook', detail:'po.updated → https://hooks.demo/app'},
    {ts:'2025-09-09 10:05', type:'api_key', detail:'Created key ending …7F3C'}
  ];
  const tb = tbl.querySelector('tbody');
  rows.forEach(r=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${r.ts}</td><td>${r.type}</td><td>${r.detail}</td>`;
    tb.appendChild(tr);
  });
})();
flex-wrap:wrap">
            <label>Company display name <input class="input" placeholder="Display name"></label>
            <label>Primary color <input class="input" placeholder="#16a34a"></label>
            <button class="btn small">Upload logo</button>
          </div>
        </div>
        <div class="card">
          <div class="section-title">Themes & Density</div>
          <div class="row" style="gap:.5rem;flex-wrap:wrap">
            <label>Default theme 
              <select id="ifTheme" class="input" style="width:160px">
                <option value="dark">Dark</option><option value="light">Light</option>
                <option value="light-warm">Warm Light</option><option value="emerald">Emerald</option>
              </select>
            </label>
            <label>Default density 
              <select id="ifDensity" class="input" style="width:140px">
                <option value="comfort">Comfort</option><option value="compact">Compact</option>
              </select>
            </label>
            <label><input id="ifAllowOverride" type="checkbox" checked> Allow user override</label>
          </div>
        </div>
      </div>
      <div class="card" style="margin-top:.5rem">
        <div class="section-title">Tabs by Role (visibility matrix)</div>
        <div id="matrixNote" class="muted small" style="margin-bottom:.25rem">Preloaded with your approved S2/F1/L1 rules. (This screen is a visual reference; changes are not persisted in this demo.)</div>
        <div id="roleMatrix" class="table small"></div>
      </div>
      <div class="card" style="margin-top:.5rem">
        <div class="section-title">Dashboard KPIs (preview)</div>
        <div id="kpiPreview"></div>
      </div>
    `;
    root.querySelector('#ifTheme').value = theme;
    root.querySelector('#ifDensity').value = density;
    const rows=[];
    Object.entries(RULES).forEach(([ctype, roles])=>{
      Object.keys(roles).forEach(role=>{
        const show=new Set(roles[role].show||[]);
        rows.push(`<tr><td><span class="pill">${ctype}</span></td><td>${role}</td>`+
          TAB_IDS.map(id=>`<td>${show.has(id)?'✓':''}</td>`).join('')+`</tr>`);
      });
    });
    root.querySelector('#roleMatrix').innerHTML =
      `<table><thead><tr><th>Company</th><th>Role</th>${TAB_IDS.map(t=>`<th>${t}</th>`).join('')}</tr></thead><tbody>${rows.join('')}</tbody></table>`;
    const container=root.querySelector('#kpiPreview');
    container.innerHTML = `<div class="grid cols-3" id="kpiPrevRow" style="margin-top:.25rem"></div>`;
    const r=container.querySelector('#kpiPrevRow');
    ['importer','processor','coop'].forEach(type=>{
      const k=computeKPIs()[type];
      const d=document.createElement('div'); d.className='card';
      d.innerHTML = `<div class="section-title" style="margin-bottom:.25rem">${type[0].toUpperCase()+type.slice(1)} KPIs</div>
        <div class="small muted">Preview</div>
        <ul class="small" style="margin:.25rem 0 0 1rem">
          <li>${k.k1.label}</li><li>${k.k2.label}</li><li>${k.k3.label}</li>
        </ul>`;
      r.appendChild(d);
    });
  }

  function renderAudit(root){
    const auditLog = (getState().auditLog||[]).concat(getState().walletAuditLog||[]).sort((a,b)=>b.ts.localeCompare(a.ts));
    root.innerHTML = `
      <div class="card">
        <div class="row-between">
            <div class="section-title">Combined Audit Log</div>
            <button id="exportAuditBtn" class="btn small">Export CSV</button>
        </div>
         <div class="row" style="gap:.5rem;

// === Injected sample: Audit & Security Logs ===
(function(){
  const host = document.querySelector('#content .panel') || root;
  const wrap = document.createElement('div'); wrap.className='grid cols-2';
  // Audit table
  const cardA = document.createElement('div'); cardA.className='card';
  cardA.innerHTML = '<div class="row-between"><div class="section-title">Company Audit Log</div><button class="btn small">Export CSV</button></div>';
  const tblA = document.createElement('table'); tblA.className='table';
  tblA.innerHTML = '<thead><tr><th>When</th><th>Actor</th><th>Action</th><th>Detail</th></tr></thead><tbody></tbody>';
  cardA.appendChild(tblA);
  // Security table
  const cardB = document.createElement('div'); cardB.className='card';
  cardB.innerHTML = '<div class="row-between"><div class="section-title">Security Events Log</div><button class="btn small">Export CSV</button></div>';
  const tblB = document.createElement('table'); tblB.className='table';
  tblB.innerHTML = '<thead><tr><th>When</th><th>Type</th><th>Reason</th><th>User</th></tr></thead><tbody></tbody>';
  cardB.appendChild(tblB);
  wrap.appendChild(cardA); wrap.appendChild(cardB);
  host.appendChild(wrap);
  const audit = [
    {ts:'2025-09-09 10:14', actor:'Sys Admin', action:'Policy change', detail:'Password policy updated'},
    {ts:'2025-09-09 12:45', actor:'Sys Admin', action:'User suspend', detail:'Suspended C_PRO:VendorUser'}
  ];
  const sec = [
    {ts:'2025-09-09 09:02', type:'failed_login', reason:'Invalid password', user:'C_IMP:User1'},
    {ts:'2025-09-09 11:17', type:'password_reset', reason:'Requested via email', user:'C_PRO:User2'}
  ];
  const tbA = tblA.querySelector('tbody'); audit.forEach(r=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${r.ts}</td><td>${r.actor}</td><td>${r.action}</td><td>${r.detail}</td>`; tbA.appendChild(tr); });
  const tbB = tblB.querySelector('tbody'); sec.forEach(r=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${r.ts}</td><td>${r.type}</td><td>${r.reason}</td><td>${r.user}</td>`; tbB.appendChild(tr); });
})();
flex-wrap:wrap;margin-bottom:.25rem">
          <input class="input" placeholder="Search text" style="min-width:200px">
          <select class="input"><option>All types</option><option>Login</option><option>Role Change</option><option>Invitation</option><option>PO</option><option>Label</option><option>QA</option><option>Document</option><option>Wallet</option><option>Override</option></select>
        </div>
        <div style="max-height: 400px; overflow-y: auto;">
        <table class="table small">
          <thead><tr><th>When</th><th>Actor</th><th>Action</th><th>Details</th></tr></thead>
          <tbody></tbody>
        </table>
        </div>
      </div>
    `;
    updateAuditTable(root, auditLog.length > 0 ? auditLog : demoAudit());

    function demoAudit(){ return [
      {ts:'2025-08-28 09:14', actor:'J. Smith @ Importer', action:'PO Update', target:'PO-2214', before:{status:'Open'}, after:{status:'Approved'}},
      {ts:'2025-08-28 09:18', actor:'A. Chan @ Processor', action:'QA Update', target:'PO-2214', after:{QA:'PASS'}},
      {ts:'2025-08-28 09:20', actor:'M. Rao @ Processor', action:'Label Update', target:'PO-2214', before:{label:'Requested'}, after:{label:'Accepted'}},
     ];}

    // Add search/filter functionality
    const searchInput = root.querySelector('input[placeholder="Search text"]');
    const typeFilter = root.querySelector('select');
    const filterLogs = debounce(() => {
      const searchTerm = (searchInput?.value || '').toLowerCase();
      const selectedType = typeFilter?.value || 'All types';
        const filtered = (auditLog.length > 0 ? auditLog : demoAudit()).filter(log => {
        const matchesSearch = !searchTerm || 
          Object.values(log).some(val => 
            String(val).toLowerCase().includes(searchTerm)
          );
        const matchesType = selectedType === 'All types' || 
          (log.action || '').toLowerCase().includes(selectedType.toLowerCase());
        return matchesSearch && matchesType;
      });
        updateAuditTable(root, filtered);
    }, 300);
    if (searchInput) searchInput.addEventListener('input', filterLogs);
    if (typeFilter) typeFilter.addEventListener('change', filterLogs);
  }

  // === Wrap original renderApp / renderDashboard with safety checks ===
  if (typeof window.renderApp === 'function') {
    const _renderApp = window.renderApp;
    window.renderApp = function(){
      const res = _renderApp.apply(this, arguments);
      try{ buildSysAdmin(); }catch(e){console.error("SysAdmin build failed:", e)}
      try{ applyTabVisibility(); }catch(e){console.error("Tab visibility failed:", e)}
      try{ injectDashboardKPIs(); }catch(e){console.error("KPI inject failed:", e)}
      return res;
    };
  }

  if (typeof window.renderDashboard === 'function') {
    const _renderDashboard = window.renderDashboard;
    window.renderDashboard = function(){
      const res=_renderDashboard.apply(this, arguments);
      try{ injectDashboardKPIs(); }catch(e){console.error("Dashboard KPI inject failed:", e)}
      return res;
    };
  }

  // Initial pass in case app is already rendered on load
  
document.addEventListener('DOMContentLoaded', ()=>{
  if(document.getElementById('nav')) { // User is logged in
    try{ applyTabVisibility(); }catch(e){}
    try{ enforceNavStrict(); }catch(e){}
    // retry a few times for late renders
    let n=0; const t=setInterval(()=>{
      try{ applyTabVisibility(); enforceNavStrict(); }catch(e){}
      if(++n>10) clearInterval(t);
    }, 150);
    if(document.getElementById('tab-sysadmin')) try{ buildSysAdmin(); }catch(e){}
  }
// injected sample
[]

// ---- Inject audit & security logs samples
try{
  const panel = document.querySelector('#content');
  const tables = panel ? panel.querySelectorAll('table') : [];
  // Company Audit Log (first table)
  const audit = tables[0];
  if(audit){
    const tb = audit.querySelector('tbody') || audit.appendChild(document.createElement('tbody'));
    if(!tb.children.length){
      [
        {ts:'2025-09-09 10:14', actor:'Sys Admin', action:'Policy change', detail:'Password policy updated'},
        {ts:'2025-09-09 12:45', actor:'Sys Admin', action:'User suspend', detail:'Suspended C_PRO:VendorUser'}
      ].forEach(r=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${r.ts}</td><td>${r.actor}</td><td>${r.action}</td><td>${r.detail}</td>`;
        tb.appendChild(tr);
      });
    }
  }
  // Security Events Log (second table)
  const sec = tables[1];
  if(sec){
    const tb2 = sec.querySelector('tbody') || sec.appendChild(document.createElement('tbody'));
    if(!tb2.children.length){
      [
        {ts:'2025-09-09 09:02', type:'failed_login', reason:'Invalid password', user:'C_IMP:User1'},
        {ts:'2025-09-09 11:17', type:'password_reset', reason:'Requested via email', user:'C_PRO:User2'}
      ].forEach(r=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${r.ts}</td><td>${r.type}</td><td>${r.reason}</td><td>${r.user}</td>`;
        tb2.appendChild(tr);
      });
    }
  }
}catch(e){}


}// ---- Inject interface activity sample
try{
  const panel = document.querySelector('#content');
  const tbls = panel ? panel.querySelectorAll('table') : null;
  let table = tbls && tbls[0] ? tbls[0] : null;
  if(table){
    const tbody = table.querySelector('tbody') || table.appendChild(document.createElement('tbody'));
    if(!tbody.children.length){
      [
        {ts:'2025-09-09 10:00', type:'webhook', detail:'po.updated → https://hooks.demo/app'},
        {ts:'2025-09-09 10:05', type:'api_key', detail:'Created key ending …7F3C'}
      ].forEach(r=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${r.ts}</td><td>${r.type}</td><td>${r.detail}</td>`;
        tbody.appendChild(tr);
      });
    }
  }
}catch(e){}


}// ---- Inject sample rows if empty
try{
  const panel = document.querySelector('#content');
  const table = panel && panel.querySelector('h2, .h2, .h3, .card, table') ? panel.querySelectorAll('table')[0] : null;
  if(table){
    const tbody = table.querySelector('tbody') || table.appendChild(document.createElement('tbody'));
    if(!tbody.children.length){
      [
        {ts:'2025-09-09 09:02', type:'failed_login', reason:'Invalid password (203.0.113.15)', user:'C_IMP:User1'},
        {ts:'2025-09-09 11:17', type:'password_reset', reason:'Requested via email', user:'C_PRO:User2'}
      ].forEach(r=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${r.ts}</td><td>${r.type}</td><td>${r.reason}</td><td>${r.user}</td>`;
        tbody.appendChild(tr);
      });
    }
  }
}catch(e){}


}/ injected sample
[]
}/ injected sample
[]
});


})();
</script>

<script>
(function(){
  const THEME_KEY='vp_theme', DENSITY_KEY='vp_density';
  function getTheme(){ return document.documentElement.getAttribute('data-theme') || 'dark'; }
  function setTheme(t){ document.documentElement.setAttribute('data-theme', t); try{ localStorage.setItem(THEME_KEY,t);}catch(e){} }
  function getDensity(){ return document.documentElement.getAttribute('data-density') || 'comfort'; }
  function setDensity(d){ document.documentElement.setAttribute('data-density', d); try{ localStorage.setItem(DENSITY_KEY,d);}catch(e){} }
  function wireLoginAppearance(){
    const themeSel = document.getElementById('vpThemeSelect');
    const densSel  = document.getElementById('vpDensitySelect');
    if(!themeSel || !densSel) return;
    themeSel.value = getTheme();
    densSel.value  = getDensity();
    themeSel.onchange = e=> setTheme(e.target.value);
    densSel.onchange  = e=> setDensity(e.target.value);
  }
  // Call after renderLogin runs
  document.addEventListener('DOMContentLoaded', wireLoginAppearance);
  // Also expose for manual call after renderLogin if needed
  window.__wireLoginAppearance = wireLoginAppearance;
})();
</script>


<script>
(function(){
  'use strict';
  // Role-aware bullets for the login promo card
  const PROMO = {
    importer: [
      "<strong>$40B</strong> lost annually to food fraud; <strong>600M</strong> people fall ill and <strong>420K</strong> die from unsafe food.",
      "<strong>30+ documents</strong> per EU shipment — errors cause costly delays and rework.",
      "<strong>Instant origin proof</strong> and EUDR-ready docs; fewer rejections with AI-checked records.",
      "<strong>Traceback in ~2 seconds</strong> with on-chain records (vs. 7 days with paper trails)."
    ],
    processor: [
      "Automated document checks with <strong>AI</strong> — fewer resubmits and faster approvals.",
      "Guided <strong>label/QA</strong> compliance; override actions are audited.",
      "Single source of truth: specs, COAs, and chain of custody are <strong>tamper-proof</strong> on blockchain.",
      "Earn <strong>VERI tokens</strong> for timely and verified submissions."
    ],
    coop: [
      "Prove <strong>origin & organic</strong> status easily; attach certs from a phone.",
      "Transparent chain of custody builds a <strong>trust score</strong> with buyers.",
      "Get paid sooner: complete docs unlock faster approvals.",
      "Earn <strong>VERI tokens</strong> for on-time, verified documentation."
    ]
  };

  function roleFromCompanyText(txt){
    txt = (txt||'').toLowerCase();
    if (txt.includes('importer')) return 'importer';
    if (txt.includes('processor')) return 'processor';
    if (txt.includes('coop') || txt.includes('co-op') || txt.includes('cooperative')) return 'coop';
    // default
    return 'importer';
  }

  function renderPromoBullets(role){
    const ul = document.querySelector('#loginPromo .promo-list');
    if(!ul) return;
    const items = PROMO[role] || PROMO.importer;
    ul.innerHTML = items.map(x=> `<li>${x}</li>`).join('');
  }

  // Wire on login page
  window.__wireLoginPromo = function(){
    const comp = document.getElementById('loginCompany');
    const selTxt = comp && comp.options && comp.options[comp.selectedIndex] ? comp.options[comp.selectedIndex].textContent : '';
    renderPromoBullets(roleFromCompanyText(selTxt));
    if (comp) {
      comp.addEventListener('change', function(){
        const t = comp.options[comp.selectedIndex].textContent;
        renderPromoBullets(roleFromCompanyText(t));
      });
    }
  };
  // If the DOM is ready and we're on the login page, initialize
  document.addEventListener('DOMContentLoaded', function(){
    if (document.getElementById('loginPromo')) {
      try { window.__wireLoginPromo(); } catch(e){}
    }
  });
})();

// Post-render nav enforcement: hide any nav buttons not allowed for this role
function enforceNavVisibility(){
  try{
    const nodes = document.querySelectorAll('.nav button');
    nodes.forEach(btn => {
      const label = (btn.textContent||'').trim();
      if(label){
        if(!isTabAllowed(label)){
          btn.style.display = 'none';
        } else {
          btn.style.display = '';
        }
      }
    });
  }catch(e){}
}

// Try to run after initial render; also observe for subsequent changes
(function(){
  const run = ()=>{ enforceNavVisibility(); };
  setTimeout(run, 0);
  const nav = document.querySelector('.nav');
  if(nav && window.MutationObserver){
    const mo = new MutationObserver(()=> enforceNavVisibility());
    mo.observe(nav, {childList:true, subtree:true});
  }
  window._vpEnforceNavVisibility = enforceNavVisibility;
})();


// Click guard: stop opening tabs not allowed by current role

// Click guard: stop opening tabs not allowed by current role (using canonical data-tab ids)
document.addEventListener('click', (ev)=>{
  try{
    const btn = ev.target.closest('.nav button');
    if(!btn) return;
    const id = btn.getAttribute('data-tab') || (btn.textContent||'').trim();
    const cid = canonTabId(id);
    const ctx = (typeof _vpCurrentContext === 'function') ? _vpCurrentContext() : {companyType:null, role:null};
    const map = (ctx.companyType && TAB_RULES[canonCompanyType(ctx.companyType)]) ? TAB_RULES[canonCompanyType(ctx.companyType)] : null;
    const rule = (map && map[canonRoleName(ctx.role)]) ? map[canonRoleName(ctx.role)] : null;
    const allowed = Array.isArray(rule) ? new Set(rule.map(canonTabId)) : new Set(((rule && rule.show)||[]).map(canonTabId));
    if (allowed.size>0 && !allowed.has(cid)){
      ev.preventDefault();
      ev.stopPropagation();
      console.warn('[TAB RULES] Blocked access to tab:', cid);
      return false;
    }
  }catch(e){}
}, true);

      return false;
    }
  }catch(e){}
}, true);


;(() => {
  const run = () => {
    try{ if (typeof applyTabVisibility === 'function') applyTabVisibility(); }catch(e){}
    try{ if (typeof _vpEnforceNavVisibility === 'function') _vpEnforceNavVisibility(); }catch(e) {}
  };
  window.addEventListener('load', () => setTimeout(run, 30));
  const root = document.querySelector('.nav');
  if (root && window.MutationObserver){
    const mo = new MutationObserver(run);
    mo.observe(root, {childList:true, subtree:true});
  }
  window._vpApplyTabs = run;
})();


// --- Strict gating driven by TAB_RULES + JSON ---
function _vpCurrentContextSafe(){
  try{
    const sess = (typeof session!=='undefined' && session) ? session
              : (window.session ? window.session : (state && state.session ? state.session : null));
    let user = null;
    if(sess && sess.userId){
      user = (state.users||[]).find(u=>u.id===sess.userId) || null;
    } else if (state && state.users && state.users.length){
      user = state.users.find(u=>u.status==='Active') || state.users[0];
    }
    if(!user) return { companyType: null, role: null };
    const company = (state.companies||[]).find(c=>c.id===user.companyId) || null;
    return { companyType: company ? company.type : null, role: user.role };
  }catch(e){ return { companyType: null, role: null }; }
}

function allowedIdsForContext(){
  const ctx = _vpCurrentContextSafe();
  const ct = canonCompanyType(ctx.companyType);
  const rr = canonRoleName(ctx.role);
  const map = (ct && TAB_RULES[ct]) ? TAB_RULES[ct] : null;
  const rule = (map && map[rr]) ? map[rr] : null;
  const arr = Array.isArray(rule) ? rule : ((rule && rule.show) ? rule.show : []);
  return new Set(arr.map(canonTabId));
}



function enforceNavStrict(){
  try{
    const nav = document.getElementById('nav') || document.querySelector('.nav');
    if(!nav) return;
    const allowed = allowedIdsForContext();
    const nodes = Array.from(nav.querySelectorAll('*')).filter(el => {
      if(!el.textContent) return false;
      const id = el.getAttribute && el.getAttribute('data-tab');
      const label = (el.textContent||'').trim();
      return !!id || ['Dashboard','Purchase Orders','Documents','Wallet','Business Partners','Invitations','Sys Admin','Log out'].includes(label);
    });
    nodes.forEach(el => {
      const id = el.getAttribute && el.getAttribute('data-tab');
      const label = (el.textContent||'').trim();
      if(/log out/i.test(label)) return;
      const cid = canonTabId(id || label);
      const ok = allowed.size>0 ? allowed.has(cid) : false;
      el.style.display = ok ? '' : 'none';
      el.classList.toggle('hidden', !ok);
    });
    // fix active
    const active = nav.querySelector('[data-tab].active, button.active');
    if(active){
      const cid = canonTabId(active.getAttribute('data-tab') || active.textContent);
      if(!allowed.has(cid)){
        const first = nav.querySelector('[data-tab]:not(.hidden)');
        if(first) first.click();
      }
    }
  }catch(e){ console.warn('enforceNavStrict error', e); }
}
);
    // Ensure active is valid
    const active = nav.querySelector('button.active,[data-tab].active');
    if(active){
      const cid = canonTabId(active.getAttribute('data-tab') || active.textContent);
      if(!allowed.has(cid)){
        const firstAllowed = nodes.find(n => n.style.display !== 'none' && n.getAttribute('data-tab'));
        if(firstAllowed) firstAllowed.click();
      }
    }
  }catch(e){ console.warn('enforceNavStrict error', e); }
}
);

    // Ensure a valid default
    const remaining = Array.from(nav.querySelectorAll('button[data-tab]'));
    if(remaining.length>0){
      const active = nav.querySelector('button.active[data-tab]');
      const aId = active ? canonTabId(active.getAttribute('data-tab')) : null;
      const aOk = active ? allowed.has(aId) : false;
      if(!aOk){
        remaining[0].click();
      }
    }
  }catch(e){ console.warn('enforceNavStrict error', e); }
}

// Validator: compare JSON (allowed) vs DOM (present buttons)
function validateTabs(){
  const nav = document.querySelector('.nav');
  if(!nav) return {ok:false, reason:'no nav'};
  const allowed = allowedIdsForContext();
  const domIds = new Set(Array.from(nav.querySelectorAll('button[data-tab]')).map(b=>canonTabId(b.getAttribute('data-tab')||b.textContent)));
  const extra = Array.from(domIds).filter(id => !allowed.has(id));
  const missing = Array.from(allowed).filter(id => !domIds.has(id));
  const ctx = _vpCurrentContextSafe();
  return {ok: extra.length===0 && missing.length===0, ctx, allowed:Array.from(allowed), dom:Array.from(domIds), extra, missing};
}

// Wire after app render + observe changes
(function(){
  const run = ()=>{ enforceNavStrict(); const r=validateTabs(); if(!r.ok){ console.warn('TAB VALIDATION', r); }};
  window.addEventListener('load', ()=> setTimeout(run, 40));
  const nav = document.querySelector('.nav');
  if(nav && window.MutationObserver){
    const mo = new MutationObserver(()=> run());
    mo.observe(nav, {childList:true, subtree:true});
  }
  window._vpEnforceNavStrict = run;
})();

// Hotkey: Alt+Shift+V to log validation
document.addEventListener('keydown', (e)=>{
  if(e.altKey && e.shiftKey && e.key.toLowerCase()==='v'){
    const r = validateTabs();
    console.log('TAB VALIDATION', r);
  }
});


// --- Robust watcher: re-apply strict gating whenever nav is (re)rendered ---
(function(){
  function run(){ try{ if (typeof _vpEnforceNavStrict === 'function') _vpEnforceNavStrict(); }catch(e){} }
  function startObserver(){
    const root = document.body || document.documentElement;
    if(!root || !window.MutationObserver){ run(); return; }
    const mo = new MutationObserver((list)=>{
      for(const m of list){
        if(m.type==='childList'){
          // Re-apply if .nav appears or its buttons change
          if([...(m.addedNodes||[])].some(n => n.nodeType===1 && (n.matches?.('.nav') || n.querySelector?.('.nav')))){
            run();
            break;
          }
        }
      }
      // Also poll dom for buttons — if present, enforce
      if(document.querySelector('.nav button[data-tab]')) run();
    });
    mo.observe(root, {childList:true, subtree:true});
    window._vpNavObserver = mo;
    // Initial + repeated passes for late renders
    run();
    let n=0;
    const tick = setInterval(()=>{ run(); if(++n>30) clearInterval(tick); }, 200); // ~6s
  }
  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', startObserver);
  } else {
    startObserver();
  }
})();


// === Hard Filter: prevent disallowed tabs from being added to nav ===
(function(){
  const _append = Element.prototype.appendChild;
  const _insertBefore = Element.prototype.insertBefore;
  function block(node){
    try{
      const nav = document.getElementById('nav') || document.querySelector('.nav');
      if(!nav) return false;
      if(!(node && node.nodeType===1)) return false;
      // only consider elements under nav
      const insideNav = node.closest ? (node.closest('#nav, .nav')!=null) : (nav.contains(node));
      if(!insideNav) return false;
      const id = node.getAttribute && (node.getAttribute('data-tab') || (node.textContent||'').trim());
      if(!id) return false;
      const cid = (typeof canonTabId==='function') ? canonTabId(id) : String(id).toLowerCase();
      if(cid==='logout') return false;
      // compute allowed for current context
      const ctx = (typeof _vpCurrentContextSafe==='function') ? _vpCurrentContextSafe() : (typeof _vpCurrentContext==='function' ? _vpCurrentContext() : {companyType:null,role:null});
      const ct = (typeof canonCompanyType==='function') ? canonCompanyType(ctx.companyType) : ctx.companyType;
      const rr = (typeof canonRoleName==='function') ? canonRoleName(ctx.role) : ctx.role;
      const map = (ct && window.TAB_RULES && TAB_RULES[ct]) ? TAB_RULES[ct] : null;
      const rule = (map && map[rr]) ? map[rr] : null;
      const allowed = Array.isArray(rule) ? new Set(rule.map(x=> (typeof canonTabId==='function')?canonTabId(x):x)) 
                    : new Set(((rule && rule.show)||[]).map(x=> (typeof canonTabId==='function')?canonTabId(x):x));
      if(allowed.size===0) return true; // strict: block all if no allowed defined
      return !allowed.has(cid);
    }catch(e){ return false; }
  }
  Element.prototype.appendChild = function(n){
    try{ if(block(n)) return n; }catch(e){}
    return _append.call(this, n);
  };
  Element.prototype.insertBefore = function(n,ref){
    try{ if(block(n)) return n; }catch(e){}
    return _insertBefore.call(this, n, ref);
  };
})();


// === SysAdmin-only primary nav enforcement ===
(function(){
  function roleIsSysAdmin(){
    try{
      const ctx = (typeof _vpCurrentContextSafe==='function') ? _vpCurrentContextSafe() : (typeof _vpCurrentContext==='function' ? _vpCurrentContext() : null);
      if(!ctx) return false;
      const r = (typeof canonRoleName==='function') ? canonRoleName(ctx.role) : ctx.role;
      return String(r||'').trim().toLowerCase() === 'sys admin'.toLowerCase();
    }catch(e){ return false; }
  }

  function enforceSysAdminOnly(){
    try{
      if(!roleIsSysAdmin()) return;
      const nav = document.getElementById('nav') || document.querySelector('.nav');
      if(!nav) return;
      const nodes = Array.from(nav.querySelectorAll('*')).filter(el => el.nodeType===1);
      nodes.forEach(el => {
        const txt = (el.textContent||'').trim();
        const id = el.getAttribute && el.getAttribute('data-tab');
        const isLogout = /log out/i.test(txt);
        const isSys = /sys\s*admin/i.test(txt) || (id && id.toLowerCase()==='sysadmin');
        // hide if it's one of our known tab labels and not Sys Admin or Logout
        const known = ['Dashboard','Purchase Orders','Documents','Wallet','Business Partners','Invitations','Sys Admin'];
        const looksLikeTab = (id!=null) || (known.includes(txt));
        if(looksLikeTab && !isSys && !isLogout){
          el.style.display = 'none';
          el.classList.add('hidden');
        }
      });
      // ensure the active tab is Sys Admin if something else was active
      const active = nav.querySelector('.active');
      const activeTxt = active ? (active.textContent||'').trim() : '';
      if(active && !/sys\s*admin/i.test(activeTxt)){
        const sysBtn = nav.querySelector('[data-tab="sysadmin"]') || Array.from(nav.querySelectorAll('*')).find(el => /sys\s*admin/i.test((el.textContent||'')));
        if(sysBtn && typeof sysBtn.click==='function') sysBtn.click();
      }
    }catch(e){}
  }

  // Run now and on changes
  const run = ()=>{ try{ enforceSysAdminOnly(); }catch(e){} };
  if(document.readyState === 'loading') document.addEventListener('DOMContentLoaded', run); else run();
  if(window.MutationObserver){
    const mo = new MutationObserver(run);
    mo.observe(document.body || document.documentElement, {childList:true, subtree:true});
  }
  window._vpSysAdminOnly = run;
})();


// === Set body data-role/company for CSS enforcement ===
(function(){
  function syncRole(){
    try{
      const ctx = (typeof _vpCurrentContextSafe==='function') ? _vpCurrentContextSafe() :
                  (typeof _vpCurrentContext==='function') ? _vpCurrentContext() : {companyType:null, role:null};
      const body = document.body || document.documentElement;
      if(!body) return;
      body.setAttribute('data-role', (typeof canonRoleName==='function') ? canonRoleName(ctx.role) : (ctx.role||''));
      body.setAttribute('data-company', (typeof canonCompanyType==='function') ? canonCompanyType(ctx.companyType) : (ctx.companyType||''));
    }catch(e){}
  }
  if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', syncRole); } else { syncRole(); }
  setTimeout(syncRole, 100);
  setTimeout(syncRole, 400);
  setTimeout(syncRole, 1000);
  if(window.MutationObserver){
    const mo = new MutationObserver(syncRole);
    mo.observe(document.body || document.documentElement, {childList:true, subtree:true});
  }
  window._vpSyncRole = syncRole;
})();

</script>

</body>
